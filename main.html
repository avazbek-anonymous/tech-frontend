<!doctype html>
<html lang="ru" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GEKTO Tech</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" />
  <link rel="stylesheet" href="/assets/adminlte.min.css" />
  <link rel="stylesheet" href="/assets/app.css" />
</head>
<body class="layout-fixed sidebar-expand-lg sidebar-open bg-body-tertiary">
  <div class="app-wrapper">
    <nav class="app-header navbar navbar-expand bg-body">
      <div class="container-fluid">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" data-lte-toggle="sidebar" href="#" role="button"><i class="bi bi-list"></i></a>
          </li>
          <li class="nav-item d-none d-md-block"><span class="nav-link fw-semibold" id="appTitle">GEKTO Tech</span></li>
        </ul>
        <ul class="navbar-nav ms-auto align-items-center">
          <li class="nav-item me-2 lang-group">
            <div class="btn-group btn-group-sm" role="group">
              <button class="btn btn-outline-secondary" data-lang="ru">RU</button>
              <button class="btn btn-outline-secondary" data-lang="uz">UZ</button>
              <button class="btn btn-outline-secondary" data-lang="en">EN</button>
            </div>
          </li>
          <li class="nav-item me-3 theme-group">
            <div class="btn-group btn-group-sm" role="group">
              <button class="btn btn-outline-secondary" data-theme="light"><i class="bi bi-sun"></i></button>
              <button class="btn btn-outline-secondary" data-theme="dark"><i class="bi bi-moon"></i></button>
            </div>
          </li>
          <li class="nav-item me-2"><span class="badge text-bg-secondary" id="who"></span></li>
          <li class="nav-item"><button class="btn btn-sm btn-outline-danger" id="logoutBtn"><i class="bi bi-box-arrow-right"></i></button></li>
        </ul>
      </div>
    </nav>

    <aside class="app-sidebar bg-body-secondary shadow" data-bs-theme="dark">
      <div class="sidebar-brand">
        <a href="#dashboard" class="brand-link">
          <span class="brand-text fw-light">GEKTO Tech</span>
        </a>
      </div>
      <div class="sidebar-wrapper">
        <nav class="mt-2">
          <ul class="nav sidebar-menu flex-column" data-lte-toggle="treeview" id="menu"></ul>
        </nav>
      </div>
    </aside>

    <main class="app-main">
      <div class="app-content-header">
        <div class="container-fluid">
          <div class="row align-items-center">
            <div class="col-sm-6"><h1 id="pageTitle">Dashboard</h1></div>
            <div class="col-sm-6"><div class="text-sm-end text-muted" id="pageSub"></div></div>
          </div>
        </div>
      </div>
      <div class="app-content">
        <div class="container-fluid" id="view"></div>
      </div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/assets/adminlte.min.js"></script>
  <script>
    const API_BASE = "https://api.tech.gekto.uz";
    const token = localStorage.getItem("tech_token") || "";
    if (!token) location.href = "/auth/login.html";

    const I18N = {
      ru: {
        dashboard: "Главное",
        businesses: "Бизнесы",
        reportsAccess: "Отчеты бизнесов",
        payments: "Оплаты",
        calendar: "Платежный календарь",
        users: "Пользователи",
        revenuePlan: "План поступлений",
        logout: "Выход",
        refresh: "Обновить",
        save: "Сохранить",
        create: "Создать",
        edit: "Редактировать",
        month: "Месяц",
        search: "Поиск",
        status: "Статус",
        active: "Актив",
        blocked: "Блок",
        draft: "Черновик",
        posted: "Проведен",
        amount: "Сумма",
        business: "Бизнес",
        action: "Действия",
        name: "Название",
        owner: "Владелец",
        ownerPhone: "Тел. владельца",
        admin: "Админ",
        adminPhone: "Тел. админа",
        filials: "Филиалы",
        tariff: "Тариф",
        tariffPrice: "Цена/филиал",
        startDate: "Дата старта",
        paymentMethod: "Способ оплаты",
        inn: "ИНН",
        phone: "Телефон",
        role: "Роль",
        email: "Логин",
        fullName: "ФИО",
        lastLogin: "Последний вход",
        noAccess: "Нет доступа",
        dashboardHint: "Сводка по активным бизнесам и платежам",
        due: "Начислено",
        paid: "Оплачено",
        debt: "Долг",
        prepayment: "Предоплата",
        monthPlan: "План месяца",
        monthFact: "Факт месяца",
        overdueCount: "Просроченные бизнесы",
        paidCount: "Оплаченные бизнесы"
      },
      uz: {
        dashboard: "Bosh sahifa",
        businesses: "Bizneslar",
        reportsAccess: "Biznes hisobotlari",
        payments: "To'lovlar",
        calendar: "To'lov taqvimi",
        users: "Foydalanuvchilar",
        revenuePlan: "Tushum rejasi",
        logout: "Chiqish",
        refresh: "Yangilash",
        save: "Saqlash",
        create: "Yaratish",
        edit: "Tahrirlash",
        month: "Oy",
        search: "Qidiruv",
        status: "Holat",
        active: "Faol",
        blocked: "Blok",
        draft: "Qoralama",
        posted: "O'tkazilgan",
        amount: "Summa",
        business: "Biznes",
        action: "Amallar",
        name: "Nomi",
        owner: "Egasi",
        ownerPhone: "Ega tel.",
        admin: "Admin",
        adminPhone: "Admin tel.",
        filials: "Filiallar",
        tariff: "Tarif",
        tariffPrice: "Narx/filial",
        startDate: "Boshlanish sanasi",
        paymentMethod: "To'lov usuli",
        inn: "STIR",
        phone: "Telefon",
        role: "Rol",
        email: "Login",
        fullName: "F.I.Sh.",
        lastLogin: "Oxirgi kirish",
        noAccess: "Ruxsat yo'q",
        dashboardHint: "Faol bizneslar va to'lovlar bo'yicha umumiy ma'lumot",
        due: "Hisoblangan",
        paid: "To'langan",
        debt: "Qarz",
        prepayment: "Oldindan to'lov",
        monthPlan: "Oy rejasi",
        monthFact: "Oy fakt",
        overdueCount: "Qarzdor bizneslar",
        paidCount: "To'langan bizneslar"
      },
      en: {
        dashboard: "Dashboard",
        businesses: "Businesses",
        reportsAccess: "Business reports",
        payments: "Payments",
        calendar: "Payment calendar",
        users: "Users",
        revenuePlan: "Revenue plan",
        logout: "Logout",
        refresh: "Refresh",
        save: "Save",
        create: "Create",
        edit: "Edit",
        month: "Month",
        search: "Search",
        status: "Status",
        active: "Active",
        blocked: "Blocked",
        draft: "Draft",
        posted: "Posted",
        amount: "Amount",
        business: "Business",
        action: "Actions",
        name: "Name",
        owner: "Owner",
        ownerPhone: "Owner phone",
        admin: "Admin",
        adminPhone: "Admin phone",
        filials: "Branches",
        tariff: "Tariff",
        tariffPrice: "Price/branch",
        startDate: "Start date",
        paymentMethod: "Payment method",
        inn: "TIN",
        phone: "Phone",
        role: "Role",
        email: "Login",
        fullName: "Full name",
        lastLogin: "Last login",
        noAccess: "No access",
        dashboardHint: "Summary of active businesses and payments",
        due: "Due",
        paid: "Paid",
        debt: "Debt",
        prepayment: "Prepayment",
        monthPlan: "Month plan",
        monthFact: "Month fact",
        overdueCount: "Overdue businesses",
        paidCount: "Paid businesses"
      }
    };

    const sections = [
      { id: "dashboard", icon: "bi-speedometer2", key: "dashboard" },
      { id: "businesses", icon: "bi-buildings", key: "businesses" },
      { id: "reports", icon: "bi-bar-chart", key: "reportsAccess" },
      { id: "payments", icon: "bi-cash-stack", key: "payments" },
      { id: "calendar", icon: "bi-calendar3", key: "calendar" },
      { id: "users", icon: "bi-people", key: "users" },
      { id: "plan", icon: "bi-graph-up-arrow", key: "revenuePlan" }
    ];

    let me = null;
    let lang = localStorage.getItem("tech_lang") || "ru";
    let theme = localStorage.getItem("tech_theme") || "light";
    let activeSection = "dashboard";

    const html = document.documentElement;
    html.lang = lang;
    html.setAttribute("data-bs-theme", theme);

    function t(k) {
      return (I18N[lang] && I18N[lang][k]) || I18N.ru[k] || k;
    }
    function fmt(n) {
      return new Intl.NumberFormat(lang === "ru" ? "ru-RU" : (lang === "uz" ? "uz-UZ" : "en-US")).format(Number(n || 0));
    }
    function esc(s) {
      return String(s || "")
        .replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;").replaceAll("'", "&#039;");
    }
    function monthNow() {
      return new Date().toISOString().slice(0, 7);
    }

    function accessFor(role) {
      const all = { read: true, write: role === "super_admin" };
      if (role === "super_admin" || role === "gekto_viewer") {
        return {
          dashboard: all, businesses: all, reports: all, payments: all, calendar: all, users: all, plan: all
        };
      }
      return {};
    }

    async function api(path, opts = {}) {
      const headers = Object.assign({}, opts.headers || {}, { Authorization: "Bearer " + token });
      const r = await fetch(API_BASE + path, Object.assign({}, opts, { headers }));
      const data = await r.json().catch(() => ({}));
      if (r.status === 401) {
        localStorage.removeItem("tech_token");
        location.href = "/auth/login.html";
        return;
      }
      if (!r.ok || !data.ok) throw new Error(data.error || ("ERR_" + r.status));
      return data;
    }

    function paintControls() {
      document.querySelectorAll("[data-lang]").forEach(b => {
        b.classList.toggle("btn-secondary", b.dataset.lang === lang);
        b.classList.toggle("btn-outline-secondary", b.dataset.lang !== lang);
      });
      document.querySelectorAll("[data-theme]").forEach(b => {
        b.classList.toggle("btn-secondary", b.dataset.theme === theme);
        b.classList.toggle("btn-outline-secondary", b.dataset.theme !== theme);
      });
      document.getElementById("logoutBtn").title = t("logout");
    }

    function renderMenu() {
      const perms = accessFor(me.role);
      const ul = document.getElementById("menu");
      ul.innerHTML = "";
      for (const s of sections) {
        if (!perms[s.id]?.read) continue;
        const li = document.createElement("li");
        li.className = "nav-item";
        li.innerHTML = `<a href="#${s.id}" class="nav-link ${activeSection === s.id ? "active" : ""}">
          <i class="nav-icon bi ${s.icon}"></i><p>${esc(t(s.key))}</p></a>`;
        ul.appendChild(li);
      }
    }

    function page(titleKey, sub = "") {
      document.getElementById("pageTitle").textContent = t(titleKey);
      document.getElementById("pageSub").textContent = sub;
    }

    async function renderDashboard() {
      page("dashboard", t("dashboardHint"));
      const month = monthNow();
      const [d, c] = await Promise.all([
        api("/gekto/dashboard?month=" + month),
        api("/gekto/payment-calendar?month=" + month)
      ]);
      document.getElementById("view").innerHTML = `
        <div class="row g-3">
          <div class="col-12 col-sm-6 col-xl-3"><div class="small-box text-bg-primary"><div class="inner"><h3>${fmt(d.metrics.active_businesses)}</h3><p>${t("businesses")}</p></div><i class="small-box-icon bi bi-buildings"></i></div></div>
          <div class="col-12 col-sm-6 col-xl-3"><div class="small-box text-bg-danger"><div class="inner"><h3>${fmt(d.metrics.overdue_businesses)}</h3><p>${t("overdueCount")}</p></div><i class="small-box-icon bi bi-exclamation-triangle"></i></div></div>
          <div class="col-12 col-sm-6 col-xl-3"><div class="small-box text-bg-success"><div class="inner"><h3>${fmt(d.metrics.month_paid_total)}</h3><p>${t("monthFact")}</p></div><i class="small-box-icon bi bi-cash-coin"></i></div></div>
          <div class="col-12 col-sm-6 col-xl-3"><div class="small-box text-bg-warning"><div class="inner"><h3>${fmt(d.metrics.month_plan_total)}</h3><p>${t("monthPlan")}</p></div><i class="small-box-icon bi bi-graph-up"></i></div></div>
        </div>
        <div class="card">
          <div class="card-header"><h3 class="card-title">${t("calendar")} (${month})</h3></div>
          <div class="card-body table-wrap">
            <table class="table table-sm table-bordered">
              <thead><tr><th>${t("business")}</th><th>${t("due")}</th><th>${t("paid")}</th><th>${t("prepayment")}</th><th>${t("debt")}</th></tr></thead>
              <tbody>
                ${(c.items || []).slice(0, 12).map(x => `<tr><td>${esc(x.business_name)}</td><td>${fmt(x.month_due)}</td><td>${fmt(x.paid_this_month)}</td><td>${fmt(x.prepayment)}</td><td>${fmt(x.debt)}</td></tr>`).join("")}
              </tbody>
            </table>
          </div>
        </div>`;
    }

    async function renderBusinesses() {
      page("businesses");
      const canWrite = accessFor(me.role).businesses.write;
      const data = await api("/gekto/businesses");
      document.getElementById("view").innerHTML = `
        ${canWrite ? `
        <div class="card mb-3"><div class="card-body">
          <div class="row g-2">
            <div class="col-md-4"><input class="form-control" id="b_name" placeholder="${t("name")}"></div>
            <div class="col-md-3"><input class="form-control" id="b_admin" placeholder="${t("admin")}"></div>
            <div class="col-md-2"><input class="form-control" id="b_filials" type="number" min="0" value="1" placeholder="${t("filials")}"></div>
            <div class="col-md-2"><input class="form-control" id="b_price" type="number" min="0" value="0" placeholder="${t("tariffPrice")}"></div>
            <div class="col-md-1 d-grid"><button class="btn btn-primary" id="b_create">${t("create")}</button></div>
          </div>
        </div></div>` : ""}
        <div class="card"><div class="card-body table-wrap">
          <table class="table table-sm table-bordered">
            <thead><tr><th>ID</th><th>${t("name")}</th><th>${t("owner")}</th><th>${t("admin")}</th><th>${t("filials")}</th><th>${t("tariff")}</th><th>${t("tariffPrice")}</th><th>${t("status")}</th>${canWrite ? `<th>${t("action")}</th>` : ""}</tr></thead>
            <tbody>
            ${(data.items || []).map(x => `<tr>
              <td>${x.id}</td><td>${esc(x.name)}</td><td>${esc(x.owner_full_name || "")}</td><td>${esc(x.admin_full_name || "")}</td>
              <td>${fmt(x.filials_count)}</td><td>${esc(x.tariff_plan)}</td><td>${fmt(x.tariff_price_per_filial)}</td><td>${esc(x.status)}</td>
              ${canWrite ? `<td><button class="btn btn-xs btn-outline-primary" data-edit="${x.id}">${t("edit")}</button></td>` : ""}
            </tr>`).join("")}
            </tbody>
          </table>
        </div></div>`;

      if (canWrite) {
        document.getElementById("b_create").onclick = async () => {
          await api("/gekto/businesses", {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              name: document.getElementById("b_name").value.trim(),
              admin_full_name: document.getElementById("b_admin").value.trim(),
              filials_count: Number(document.getElementById("b_filials").value || 1),
              tariff_price_per_filial: Number(document.getElementById("b_price").value || 0)
            })
          });
          renderBusinesses();
        };
        document.querySelectorAll("[data-edit]").forEach(btn => btn.onclick = async () => {
          const id = Number(btn.dataset.edit);
          const status = prompt("status: active|blocked", "active");
          if (!status) return;
          await api("/gekto/businesses/" + id, {
            method: "PATCH", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status })
          });
          renderBusinesses();
        });
      }
    }

    async function renderReports() {
      page("reportsAccess");
      const canWrite = accessFor(me.role).reports.write;
      const list = await api("/gekto/business-reports");
      document.getElementById("view").innerHTML = `
        <div class="card"><div class="card-body table-wrap">
          <table class="table table-sm table-bordered">
            <thead><tr><th>ID</th><th>${t("business")}</th><th>Enabled</th>${canWrite ? `<th>${t("action")}</th>` : ""}</tr></thead>
            <tbody>
              ${(list.items || []).map(x => `<tr><td>${x.business_id}</td><td>${esc(x.business_name)}</td><td>${esc(x.enabled_reports || "")}</td>${canWrite ? `<td><button class="btn btn-xs btn-outline-primary" data-open="${x.business_id}">${t("edit")}</button></td>` : ""}</tr>`).join("")}
            </tbody>
          </table>
        </div></div>`;
      if (!canWrite) return;
      document.querySelectorAll("[data-open]").forEach(btn => btn.onclick = async () => {
        const id = Number(btn.dataset.open);
        const detail = await api("/gekto/business-reports/" + id);
        const current = detail.reports.filter(r => Number(r.is_enabled) === 1).map(r => r.code).join(",");
        const next = prompt("codes comma separated", current);
        if (next === null) return;
        const enabledSet = new Set(next.split(",").map(s => s.trim()).filter(Boolean));
        const payload = detail.reports.map(r => ({ code: r.code, is_enabled: enabledSet.has(r.code) ? 1 : 0 }));
        await api("/gekto/business-reports/" + id, {
          method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ reports: payload })
        });
        renderReports();
      });
    }

    async function renderPayments() {
      page("payments");
      const canWrite = accessFor(me.role).payments.write;
      const data = await api("/gekto/payments");
      const businesses = await api("/gekto/businesses");
      document.getElementById("view").innerHTML = `
        ${canWrite ? `<div class="card mb-3"><div class="card-body"><div class="row g-2">
          <div class="col-md-3"><select id="p_business" class="form-select">${(businesses.items || []).map(b => `<option value="${b.id}">${esc(b.name)}</option>`).join("")}</select></div>
          <div class="col-md-2"><input id="p_date" type="date" class="form-control" value="${new Date().toISOString().slice(0,10)}"></div>
          <div class="col-md-2"><input id="p_amount" type="number" min="0" value="0" class="form-control" placeholder="${t("amount")}"></div>
          <div class="col-md-2"><select id="p_status" class="form-select"><option value="draft">${t("draft")}</option><option value="posted">${t("posted")}</option></select></div>
          <div class="col-md-3 d-grid"><button class="btn btn-primary" id="p_create">${t("create")}</button></div>
        </div></div></div>` : ""}
        <div class="card"><div class="card-body table-wrap">
          <table class="table table-sm table-bordered">
            <thead><tr><th>ID</th><th>${t("business")}</th><th>Date</th><th>${t("amount")}</th><th>${t("tariff")}</th><th>${t("status")}</th>${canWrite ? `<th>${t("action")}</th>` : ""}</tr></thead>
            <tbody>
            ${(data.items || []).map(x => `<tr>
              <td>${x.id}</td><td>${esc(x.business_name)}</td><td>${esc(x.payment_date)}</td><td>${fmt(x.amount)}</td><td>${esc(x.tariff_plan)}</td><td>${esc(x.status)}</td>
              ${canWrite ? `<td><button class="btn btn-xs btn-outline-primary" data-post="${x.id}">${t("posted")}</button></td>` : ""}
            </tr>`).join("")}
            </tbody>
          </table>
        </div></div>`;
      if (canWrite) {
        document.getElementById("p_create").onclick = async () => {
          await api("/gekto/payments", {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              business_id: Number(document.getElementById("p_business").value),
              payment_date: document.getElementById("p_date").value,
              amount: Number(document.getElementById("p_amount").value || 0),
              tariff_plan: "monthly",
              status: document.getElementById("p_status").value
            })
          });
          renderPayments();
        };
        document.querySelectorAll("[data-post]").forEach(btn => btn.onclick = async () => {
          const id = Number(btn.dataset.post);
          await api("/gekto/payments/" + id, {
            method: "PATCH", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ status: "posted" })
          });
          renderPayments();
        });
      }
    }

    async function renderCalendar() {
      page("calendar");
      const month = monthNow();
      const data = await api("/gekto/payment-calendar?month=" + month);
      document.getElementById("view").innerHTML = `
        <div class="card"><div class="card-header"><h3 class="card-title">${month}</h3></div>
        <div class="card-body table-wrap">
          <table class="table table-sm table-bordered">
            <thead><tr><th>${t("business")}</th><th>${t("startDate")}</th><th>${t("tariff")}</th><th>${t("tariffPrice")}</th><th>${t("filials")}</th><th>${t("due")}</th><th>${t("paid")}</th><th>${t("prepayment")}</th><th>${t("debt")}</th></tr></thead>
            <tbody>${(data.items || []).map(x => `<tr><td>${esc(x.business_name)}</td><td>${esc(x.subscription_start_date || "")}</td><td>${esc(x.tariff_plan)}</td><td>${fmt(x.tariff_price_per_filial)}</td><td>${fmt(x.filials_count)}</td><td>${fmt(x.month_due)}</td><td>${fmt(x.paid_this_month)}</td><td>${fmt(x.prepayment)}</td><td>${fmt(x.debt)}</td></tr>`).join("")}</tbody>
          </table>
        </div></div>`;
    }

    async function renderUsers() {
      page("users");
      const canWrite = accessFor(me.role).users.write;
      const users = await api("/gekto/users?scope=all");
      const businesses = await api("/gekto/businesses");
      document.getElementById("view").innerHTML = `
        ${canWrite ? `<div class="card mb-3"><div class="card-body"><div class="row g-2">
          <div class="col-md-2"><input id="u_name" class="form-control" placeholder="${t("fullName")}"></div>
          <div class="col-md-2"><input id="u_email" class="form-control" placeholder="${t("email")}"></div>
          <div class="col-md-2"><input id="u_phone" class="form-control" placeholder="${t("phone")}"></div>
          <div class="col-md-2"><input id="u_pwd" class="form-control" type="password" placeholder="password"></div>
          <div class="col-md-2"><select id="u_role" class="form-select"><option value="gekto_viewer">gekto_viewer</option><option value="super_admin">super_admin</option><option value="business_owner">business_owner</option></select></div>
          <div class="col-md-2"><select id="u_biz" class="form-select"><option value="">GEKTO</option>${(businesses.items || []).map(b => `<option value="${b.id}">${esc(b.name)}</option>`).join("")}</select></div>
          <div class="col-md-12 d-grid"><button class="btn btn-primary mt-1" id="u_create">${t("create")}</button></div>
        </div></div></div>` : ""}
        <div class="card"><div class="card-body table-wrap">
          <table class="table table-sm table-bordered">
            <thead><tr><th>ID</th><th>${t("fullName")}</th><th>${t("email")}</th><th>${t("phone")}</th><th>${t("role")}</th><th>${t("business")}</th><th>${t("lastLogin")}</th><th>${t("status")}</th>${canWrite ? `<th>${t("action")}</th>` : ""}</tr></thead>
            <tbody>${(users.items || []).map(u => `<tr>
              <td>${u.id}</td><td>${esc(u.full_name)}</td><td>${esc(u.email)}</td><td>${esc(u.phone || "")}</td><td>${esc(u.role)}</td><td>${esc(u.business_name || "GEKTO")}</td><td>${u.last_login_at ? new Date(u.last_login_at * 1000).toLocaleString() : "-"}</td><td>${u.is_active ? t("active") : t("blocked")}</td>
              ${canWrite ? `<td><button class="btn btn-xs btn-outline-primary" data-toggle="${u.id}" data-next="${u.is_active ? 0 : 1}">${u.is_active ? t("blocked") : t("active")}</button></td>` : ""}
            </tr>`).join("")}</tbody>
          </table>
        </div></div>`;
      if (canWrite) {
        document.getElementById("u_create").onclick = async () => {
          const role = document.getElementById("u_role").value;
          const bizVal = document.getElementById("u_biz").value;
          await api("/gekto/users", {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              full_name: document.getElementById("u_name").value.trim(),
              email: document.getElementById("u_email").value.trim(),
              phone: document.getElementById("u_phone").value.trim(),
              password: document.getElementById("u_pwd").value,
              role,
              business_id: bizVal ? Number(bizVal) : null
            })
          });
          renderUsers();
        };
        document.querySelectorAll("[data-toggle]").forEach(btn => btn.onclick = async () => {
          await api("/gekto/users/" + btn.dataset.toggle, {
            method: "PATCH", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ is_active: Number(btn.dataset.next) })
          });
          renderUsers();
        });
      }
    }

    async function renderPlan() {
      page("revenuePlan");
      const canWrite = accessFor(me.role).plan.write;
      const month = monthNow();
      const item = (await api("/gekto/revenue-plan?month=" + month)).item;
      document.getElementById("view").innerHTML = `
        <div class="card"><div class="card-body">
          <div class="row g-2 align-items-end">
            <div class="col-md-3"><label class="form-label">${t("month")}</label><input class="form-control" value="${month}" readonly></div>
            <div class="col-md-4"><label class="form-label">${t("monthPlan")}</label><input id="planValue" type="number" min="0" class="form-control" value="${Number(item.planned_amount || 0)}" ${canWrite ? "" : "disabled"}></div>
            ${canWrite ? `<div class="col-md-2 d-grid"><button class="btn btn-primary" id="planSave">${t("save")}</button></div>` : ""}
          </div>
        </div></div>`;
      if (canWrite) {
        document.getElementById("planSave").onclick = async () => {
          await api("/gekto/revenue-plan", {
            method: "PUT", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ month_key: month, planned_amount: Number(document.getElementById("planValue").value || 0) })
          });
          renderPlan();
        };
      }
    }

    async function renderCurrent() {
      const perms = accessFor(me.role);
      if (!perms[activeSection]?.read) {
        document.getElementById("view").innerHTML = `<div class="alert alert-danger">${t("noAccess")}</div>`;
        return;
      }
      try {
        if (activeSection === "dashboard") return await renderDashboard();
        if (activeSection === "businesses") return await renderBusinesses();
        if (activeSection === "reports") return await renderReports();
        if (activeSection === "payments") return await renderPayments();
        if (activeSection === "calendar") return await renderCalendar();
        if (activeSection === "users") return await renderUsers();
        if (activeSection === "plan") return await renderPlan();
      } catch (e) {
        document.getElementById("view").innerHTML = `<div class="alert alert-danger">${esc(e.message || e)}</div>`;
      }
    }

    async function bootstrap() {
      me = (await api("/me")).user;
      if (!["super_admin", "gekto_viewer"].includes(me.role)) {
        localStorage.removeItem("tech_token");
        location.href = "/auth/login.html";
        return;
      }
      document.getElementById("who").textContent = `${me.full_name} (${me.role})`;
      const hash = (location.hash || "#dashboard").replace("#", "");
      activeSection = sections.find(s => s.id === hash) ? hash : "dashboard";
      renderMenu();
      paintControls();
      await renderCurrent();
    }

    window.addEventListener("hashchange", () => {
      activeSection = (location.hash || "#dashboard").replace("#", "");
      renderMenu();
      renderCurrent();
    });

    document.querySelectorAll("[data-lang]").forEach(btn => btn.addEventListener("click", () => {
      lang = btn.dataset.lang;
      localStorage.setItem("tech_lang", lang);
      html.lang = lang;
      paintControls();
      renderMenu();
      renderCurrent();
    }));
    document.querySelectorAll("[data-theme]").forEach(btn => btn.addEventListener("click", () => {
      theme = btn.dataset.theme;
      localStorage.setItem("tech_theme", theme);
      html.setAttribute("data-bs-theme", theme);
      paintControls();
    }));

    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("tech_token");
      location.href = "/auth/login.html";
    });

    bootstrap();
  </script>
</body>
</html>
