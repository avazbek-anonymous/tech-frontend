<!doctype html>
<html lang="ru" data-theme="light" data-lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tech — Login</title>

  <!-- общий стиль системы -->
  <link rel="stylesheet" href="/assets/app.css" />

  <!-- login-only polish -->
  <style>
    :root{
      --auth-max: 420px;
    }
    body{
      margin:0;
      min-height:100dvh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(42,140,255,.18), transparent 60%),
        radial-gradient(900px 500px at 80% 90%, rgba(156,79,255,.14), transparent 60%);
    }

    .auth-wrap{ width:min(100%, var(--auth-max)); }
    .auth-card{
      border: 1px solid var(--border);
      border-radius: 20px;
      box-shadow: var(--shadow);
      background: rgba(255,255,255,.10);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:hidden;
    }
    html[data-theme="dark"] .auth-card{
      background: rgba(255,255,255,.06);
    }

    .auth-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 14px 14px 12px;
      border-bottom: 1px solid var(--border);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .logo{
      width:40px; height:40px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(42,140,255,.18);
      display:flex;
      align-items:center;
      justify-content:center;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      flex:0 0 auto;
    }
    .brand-txt{ min-width:0; }
    .brand-txt .t1{
      font-weight:900;
      font-size: 16px;
      line-height: 1.1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      color: var(--text);
    }
    .brand-txt .t2{
      font-size: 12px;
      color: var(--muted);
      margin-top:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .top-actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex:0 0 auto;
    }

    /* делаем кнопки как в системе */
    .btn, .inp{ min-height:44px; height:44px; border-radius:14px; }
    .btn.icon{ width:44px; padding:0; }
    @media (min-width: 821px){
      .btn, .inp{ min-height:40px; height:40px; border-radius:12px; }
      .btn.icon{ width:40px; }
    }

    .auth-body{ padding: 14px; }
    .auth-title{
      font-size: 18px;
      font-weight: 900;
      margin: 2px 0 6px;
      color: var(--text);
    }
    .auth-sub{
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 12px;
    }

    .field{ display:flex; flex-direction:column; gap:6px; margin-bottom: 12px; }
    .field label{ font-size: 12px; color: var(--muted); }

    .inp{
      width:100%;
      box-sizing:border-box;
      padding: 0 12px;
    }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-top: 6px;
      flex-wrap:wrap;
    }
    .hint{
      font-size: 12px;
      color: var(--muted);
      line-height:1.3;
    }

    .msg{
      margin-top: 10px;
      font-size: 13px;
      color: var(--muted);
      min-height: 18px;
    }
    .msg.err{ color: var(--danger); }
    .msg.ok{ color: var(--ok, #2aa876); }

    .api{
      margin-top: 12px;
      padding-top: 10px;
      border-top: 1px solid var(--border);
      font-size: 12px;
      color: var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    .pw-wrap{ position:relative; }
    .pw-eye{
      position:absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
    }
    .pw-eye.btn.icon{
      background: transparent;
      border: 1px solid var(--border);
    }

    .divider{
      height:1px;
      background: var(--border);
      margin: 12px 0;
      opacity:.9;
    }
  </style>
</head>

<body>
  <div class="auth-wrap">
    <div class="auth-card">
      <div class="auth-top">
        <div class="brand">
          <div class="logo" aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M4 12h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M12 4v16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          <div class="brand-txt">
            <div class="t1" id="brandTitle">Tech System</div>
            <div class="t2" id="brandSub">Sign in to continue</div>
          </div>
        </div>

        <div class="top-actions">
          <button id="themeBtn" class="btn" style="min-width:92px;"></button>
          <button id="langBtn" class="btn" style="min-width:72px;"></button>
        </div>
      </div>

      <div class="auth-body">
        <div class="auth-title" id="title">Login</div>
        <div class="auth-sub" id="subtitle">Use your account credentials</div>

        <div class="field">
          <label id="lblEmail">Email</label>
          <input id="email" class="inp" type="email" autocomplete="email" placeholder="you@mail.com" />
        </div>

        <div class="field">
          <label id="lblPass">Password</label>
          <div class="pw-wrap">
            <input id="password" class="inp" type="password" autocomplete="current-password" placeholder="••••••••" />
            <button id="eye" class="btn icon pw-eye" type="button" title="Show/Hide" aria-label="Show/Hide">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7S2 12 2 12Z" stroke="currentColor" stroke-width="2"/>
                <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" stroke="currentColor" stroke-width="2"/>
              </svg>
            </button>
          </div>
        </div>

        <button id="btn" class="btn primary" style="width:100%;">Sign in</button>

        <div class="row">
          <div class="hint" id="hint"></div>
          <button id="clear" class="btn" type="button" style="min-width:140px;">
            Clear token
          </button>
        </div>

        <div id="msg" class="msg"></div>

        <div class="api">
          <div>API: <span id="apiBase"></span></div>
          <div id="meLine"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "https://api.tech.gekto.uz";
    document.getElementById("apiBase").textContent = API_BASE;

    const KEY_LANG  = "tech_lang";
    const KEY_THEME = "tech_theme";
    const KEY_TOKEN = "tech_token";

    const T = {
      ru: {
        brandSub: "Войдите, чтобы продолжить",
        title: "Вход",
        subtitle: "Введите email и пароль",
        email: "Email",
        pass: "Пароль",
        signIn: "Войти",
        clear: "Удалить токен",
        hint: "После входа вы попадёте в систему.",
        loading: "Вход...",
        fill: "Заполни email и пароль",
        ok: "Успешно: ",
        sessionOk: "Ты уже вошёл: ",
        expired: "Сессия устарела — войди заново",
        checkErr: "Ошибка проверки токена: ",
        loginErr: "Ошибка входа: ",
        meFail: "Токен получен, но /me не прошёл: ",
        themeLight: "Light",
        themeDark: "Dark",
      },
      uz: {
        brandSub: "Davom etish uchun kiring",
        title: "Kirish",
        subtitle: "Email va parolni kiriting",
        email: "Email",
        pass: "Parol",
        signIn: "Kirish",
        clear: "Tokenni o‘chirish",
        hint: "Kirgandan so‘ng tizimga o‘tasiz.",
        loading: "Kirilmoqda...",
        fill: "Email va parolni to‘ldiring",
        ok: "Muvaffaqiyatli: ",
        sessionOk: "Allaqachon kirgansiz: ",
        expired: "Sessiya eskirgan — qayta kiring",
        checkErr: "Token tekshirish xatosi: ",
        loginErr: "Kirish xatosi: ",
        meFail: "Token bor, lekin /me ishlamadi: ",
        themeLight: "Light",
        themeDark: "Dark",
      },
      en: {
        brandSub: "Sign in to continue",
        title: "Login",
        subtitle: "Enter email and password",
        email: "Email",
        pass: "Password",
        signIn: "Sign in",
        clear: "Clear token",
        hint: "After sign-in you’ll enter the system.",
        loading: "Signing in...",
        fill: "Enter email and password",
        ok: "Success: ",
        sessionOk: "Already signed in: ",
        expired: "Session expired — please sign in again",
        checkErr: "Token check error: ",
        loginErr: "Login error: ",
        meFail: "Token received, but /me failed: ",
        themeLight: "Light",
        themeDark: "Dark",
      }
    };

    const html = document.documentElement;

    function getLang(){
      const v = (localStorage.getItem(KEY_LANG) || html.getAttribute("data-lang") || "ru").toLowerCase();
      return (v === "uz" || v === "en") ? v : "ru";
    }
    function setLang(v){
      const next = (v === "uz" || v === "en") ? v : "ru";
      localStorage.setItem(KEY_LANG, next);
      html.setAttribute("data-lang", next);
      applyI18n();
    }
    function getTheme(){
      const v = (localStorage.getItem(KEY_THEME) || html.getAttribute("data-theme") || "light").toLowerCase();
      return v === "dark" ? "dark" : "light";
    }
    function setTheme(v){
      const next = v === "dark" ? "dark" : "light";
      localStorage.setItem(KEY_THEME, next);
      html.setAttribute("data-theme", next);
      applyI18n();
    }
    function t(key){
      const lg = getLang();
      return (T[lg] && T[lg][key]) ? T[lg][key] : (T.ru[key] || key);
    }

    const emailEl  = document.getElementById("email");
    const passEl   = document.getElementById("password");
    const msgEl    = document.getElementById("msg");
    const btnEl    = document.getElementById("btn");
    const clearEl  = document.getElementById("clear");
    const themeBtn = document.getElementById("themeBtn");
    const langBtn  = document.getElementById("langBtn");
    const meLine   = document.getElementById("meLine");
    const eyeBtn   = document.getElementById("eye");

    function setMsg(text, kind=""){
      msgEl.className = "msg" + (kind ? (" " + kind) : "");
      msgEl.textContent = text || "";
    }

    function applyI18n(){
      document.getElementById("brandSub").textContent = t("brandSub");
      document.getElementById("title").textContent = t("title");
      document.getElementById("subtitle").textContent = t("subtitle");
      document.getElementById("lblEmail").textContent = t("email");
      document.getElementById("lblPass").textContent = t("pass");
      btnEl.textContent = t("signIn");
      clearEl.textContent = t("clear");
      document.getElementById("hint").textContent = t("hint");

      const th = getTheme();
      themeBtn.textContent = (th === "dark") ? t("themeDark") : t("themeLight");

      const lg = getLang();
      langBtn.textContent = (lg === "uz") ? "UZ" : (lg === "en") ? "EN" : "RU";
    }

    themeBtn.addEventListener("click", () => setTheme(getTheme() === "dark" ? "light" : "dark"));
    langBtn.addEventListener("click", () => {
      const cur = getLang();
      const next = (cur === "ru") ? "uz" : (cur === "uz") ? "en" : "ru";
      setLang(next);
    });

    eyeBtn.addEventListener("click", () => {
      const isPw = passEl.type === "password";
      passEl.type = isPw ? "text" : "password";
    });

    clearEl.addEventListener("click", () => {
      localStorage.removeItem(KEY_TOKEN);
      meLine.textContent = "";
      setMsg("", "");
      setMsg(getLang()==="ru" ? "Токен удалён." : (getLang()==="uz" ? "Token o‘chirildi." : "Token cleared."), "ok");
    });

    async function checkToken(){
      const token = localStorage.getItem(KEY_TOKEN);
      if (!token) return;

      try {
        const r = await fetch(API_BASE + "/me", { headers: { "Authorization": "Bearer " + token }});
        const me = await r.json().catch(() => ({}));

        if (r.ok && me.ok && me.user) {
          const name = me.user.full_name || "";
          const role = me.user.role || "";
          meLine.textContent = (getLang()==="en")
            ? `${t("sessionOk")}${name} (${role})`
            : `${t("sessionOk")}${name} (${role})`;
          setMsg(t("sessionOk") + name + " (" + role + ")", "ok");
        } else {
          localStorage.removeItem(KEY_TOKEN);
          meLine.textContent = "";
          setMsg(t("expired"), "err");
        }
      } catch (e) {
        setMsg(t("checkErr") + (e?.message || e), "err");
      }
    }

    async function doLogin(){
      const email = (emailEl.value || "").trim();
      const password = (passEl.value || "");

      if (!email || !password) {
        setMsg(t("fill"), "err");
        return;
      }

      btnEl.disabled = true;
      setMsg(t("loading"), "");

      try {
        const r = await fetch(API_BASE + "/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password }),
        });
        const data = await r.json().catch(() => ({}));

        if (!r.ok || !data.ok || !data.token) {
          setMsg((data.error ? data.error : (t("loginErr") + r.status)), "err");
          return;
        }

        localStorage.setItem(KEY_TOKEN, data.token);

        // verify /me
        const r2 = await fetch(API_BASE + "/me", { headers: { "Authorization": "Bearer " + data.token } });
        const me = await r2.json().catch(() => ({}));

        if (r2.ok && me.ok && me.user) {
          setMsg(t("ok") + me.user.full_name + " (" + me.user.role + ")", "ok");
          // переход в систему (main.html) — если ещё не создали, потом поменяем
          setTimeout(() => location.href = "/main.html", 350);
        } else {
          setMsg(t("meFail") + (me.error || r2.status), "err");
        }
      } catch (e) {
        setMsg("Error: " + (e?.message || e), "err");
      } finally {
        btnEl.disabled = false;
      }
    }

    // enter to submit
    [emailEl, passEl].forEach(el => el.addEventListener("keydown", (e) => {
      if (e.key === "Enter") doLogin();
    }));

    // init
    setTheme(getTheme());
    setLang(getLang());
    applyI18n();
    checkToken();
    btnEl.addEventListener("click", doLogin);
  </script>
</body>
</html>
