<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tech — Вход</title>
</head>
<body style="font-family: Arial, sans-serif; padding: 24px; max-width: 520px; margin: 0 auto;">
  <h2 style="margin:0 0 12px;">Вход</h2>

  <div style="padding:12px; border:1px solid #ddd; border-radius:12px;">
    <label style="display:block; margin-bottom:6px;">Email</label>
    <input id="email" type="email" placeholder="you@mail.com"
      style="width:100%; padding:10px; border:1px solid #ccc; border-radius:10px; box-sizing:border-box;" />

    <label style="display:block; margin:12px 0 6px;">Пароль</label>
    <input id="password" type="password" placeholder="YOUR_PASSWORD"
      style="width:100%; padding:10px; border:1px solid #ccc; border-radius:10px; box-sizing:border-box;" />

    <button id="btn"
      style="margin-top:14px; width:100%; padding:10px; border:0; border-radius:10px; cursor:pointer;">
      Войти
    </button>

    <div id="msg" style="margin-top:12px; font-size:14px;"></div>

    <div style="margin-top:12px; font-size:12px; color:#666;">
      API: <span id="apiBase"></span>
    </div>
  </div>

  <script>
    const API_BASE = "https://api.tech.gekto.uz";
    document.getElementById("apiBase").textContent = API_BASE;

    const emailEl = document.getElementById("email");
    const passEl  = document.getElementById("password");
    const msgEl   = document.getElementById("msg");
    const btnEl   = document.getElementById("btn");

    function setMsg(text, ok=false) {
      msgEl.textContent = text;
      msgEl.style.color = ok ? "green" : "crimson";
    }

    btnEl.addEventListener("click", async () => {
      const email = (emailEl.value || "").trim();
      const password = (passEl.value || "");

      if (!email || !password) {
        setMsg("Заполни email и пароль");
        return;
      }

      btnEl.disabled = true;
      setMsg("Вход...");

      try {
        const r = await fetch(API_BASE + "/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password }),
        });

        const data = await r.json().catch(() => ({}));

        if (!r.ok || !data.ok || !data.token) {
          setMsg(data.error || ("Ошибка входа (" + r.status + ")"));
          btnEl.disabled = false;
          return;
        }

        localStorage.setItem("tech_token", data.token);

        // проверка /me
        const r2 = await fetch(API_BASE + "/me", {
          headers: { "Authorization": "Bearer " + data.token }
        });
        const me = await r2.json().catch(() => ({}));

        if (r2.ok && me.ok) {
          setMsg("Успешно: " + me.user.full_name + " (" + me.user.role + ")", true);
        } else {
          setMsg("Токен получен, но /me не прошёл: " + (me.error || r2.status));
        }
      } catch (e) {
        setMsg("Ошибка: " + (e?.message || e));
      } finally {
        btnEl.disabled = false;
      }
    });
  </script>
</body>
</html>
