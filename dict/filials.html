<!doctype html>
<html lang="ru" data-theme="light" data-sidebar="open" data-lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tech — Филиалы</title>
  <link rel="stylesheet" href="/assets/app.css" />
</head>

<body>
  <div id="app"></div>

  <script type="module">
    import { renderShell } from "/assets/shell.js";
    import { getLang, t } from "/assets/app.js";


    const API_BASE = "https://api.tech.gekto.uz";

    const ui = renderShell({ active: "filials", titleKey: "filials" });

    let allItems = [];

    function token() {
      return localStorage.getItem("tech_token") || "";
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function fmtTs(ts) {
      if (!ts) return "";
      const d = new Date(ts * 1000);
      return d.toLocaleString();
    }

    async function apiFetch(path, opts = {}) {
      const tkn = token();
      if (!tkn) throw new Error("NO_TOKEN");

      const headers = Object.assign({}, opts.headers || {}, {
        "Authorization": "Bearer " + tkn
      });

      const r = await fetch(API_BASE + path, Object.assign({}, opts, { headers }));
      const data = await r.json().catch(() => ({}));

      if (r.status === 401) {
        localStorage.removeItem("tech_token");
        throw new Error("UNAUTHORIZED");
      }
      if (!r.ok || !data.ok) throw new Error(data.error || ("ERR_" + r.status));
      return data;
    }

    async function loadWho() {
      try {
        const data = await apiFetch("/me");
        ui.setWho(getLang() === "uz"
          ? `Siz: ${data.user.full_name} (${data.user.role})`
          : `Ты: ${data.user.full_name} (${data.user.role})`
        );
      } catch {
        ui.setWho("");
      }
    }

    function renderTable() {
        const yes = t("yes");
        const no  = t("no");

        const q = (document.getElementById("q")?.value || "").trim().toLowerCase();
        const items = q ? allItems.filter(x => String(x.name||"").toLowerCase().includes(q)) : allItems;

        ui.setSub(items.length ? `(${items.length})` : "");

        if (!items.length) {
            ui.bodyEl.innerHTML = `
            <div class="tablewrap">
                <table>
                <tbody><tr><td style="padding:12px;">—</td></tr></tbody>
                </table>
            </div>`;
            return;
        }

        ui.bodyEl.innerHTML = `
            <div class="tablewrap">
                <table>
                    <thead>
                        <tr>
                            <th style="width:90px;">ID</th>
                            <th>${t("name")}</th>
                            <th style="width:120px;">${t("active")}</th>
                            <th style="width:200px;">${t("created")}</th>
                            <th style="width:260px;">${t("actions")}</th>
                        </tr>
                        </thead>
                        <tbody id="rows">
                        ${items.map(x => `
                            <tr style="opacity:${x.is_active ? "1" : "0.55"}">
                            <td>${x.id}</td>
                            <td>${escapeHtml(x.name)}</td>
                            <td>${x.is_active ? yes : no}</td>
                            <td>${fmtTs(x.created_at)}</td>
                            <td style="display:flex; gap:8px; flex-wrap:wrap;">
                                <button class="btn" data-act="rename" data-id="${x.id}">${t("rename")}</button>
                                <button class="btn" data-act="toggle" data-id="${x.id}" data-next="${x.is_active ? 0 : 1}">
                                ${x.is_active ? t("disable") : t("enable")}
                                </button>
                            </td>
                            </tr>
                        `).join("")}
                    </tbody>
                </table>
            </div>`;
    }

    function mountActions() {
    ui.actionsEl.innerHTML = `
        <input id="q" class="inp" placeholder="${t("search")}" style="width:220px;" />
        <button id="refresh" class="btn">${t("refresh")}</button>
        <button id="add" class="btn primary">${t("add")}</button>
    `;

    document.getElementById("q").addEventListener("input", () => renderTable());
    document.getElementById("refresh").addEventListener("click", () => load());
    document.getElementById("add").addEventListener("click", async () => {
        const name = prompt(t("branch_name"));
        if (!name) return;

        ui.setMsg(getLang()==="uz" ? "Yaratilmoqda..." : (getLang()==="en" ? "Creating..." : "Создаю..."), true);
        await apiFetch("/filials", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: name.trim() })
        });

        await load();
    });
    }


    async function load() {
      const lg = getLang();
      try {
        ui.setMsg(lg === "uz" ? "Yuklanmoqda..." : "Загружаю...", true);
        const data = await apiFetch("/filials");
        allItems = data.items || [];
        ui.setMsg("", true);
        mountActions();
        renderTable();
      } catch (e) {
        const m = String(e.message || e);
        if (m === "NO_TOKEN" || m === "UNAUTHORIZED") {
          ui.setMsg(lg === "uz" ? "Iltimos, avval kiring (/auth/login.html)" : "Сначала войди (/auth/login.html)", false);
        } else {
          ui.setMsg("Ошибка: " + m, false);
        }
      }
    }

    // table buttons (rename/toggle)
    ui.bodyEl.addEventListener("click", async (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;

      const act = btn.getAttribute("data-act");
      const id = btn.getAttribute("data-id");
      if (!act || !id) return;

      const cur = allItems.find(x => String(x.id) === String(id));
      if (!cur) return;

      const lg = getLang();

      if (act === "rename") {
        const nextName = prompt(lg==="uz" ? "Yangi nom:" : "Новое название:", cur.name || "");
        if (nextName === null) return;
        const nn = String(nextName).trim();
        if (!nn) return;

        await apiFetch("/filials/" + id, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name: nn })
        });
        await load();
      }

      if (act === "toggle") {
        const next = Number(btn.getAttribute("data-next"));
        const conf = (lg === "uz")
          ? `"${cur.name}" filialini ${next===1 ? "yoqish" : "o‘chirish"}?`
          : `Точно ${next===1 ? "включить" : "выключить"} филиал "${cur.name}"?`;

        if (!confirm(conf)) return;

        await apiFetch("/filials/" + id, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ is_active: next })
        });
        await load();
      }
    });

    await loadWho();
    mountActions();
    await load();

    // Когда меняем язык — shell перерисует тексты кнопок в шапке,
    // а мы обновим actions/table под новый язык простым перезагрузом.
    window.addEventListener("storage", (e) => {
      if (e.key === "tech_lang") {
        mountActions();
        renderTable();
        loadWho();
      }
    });
  </script>
</body>
</html>
