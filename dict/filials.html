<!doctype html>
<html lang="ru" data-theme="light" data-sidebar="open" data-lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tech — Филиалы</title>
  <link rel="stylesheet" href="/assets/app.css" />
</head>

<body>
  <div id="app"></div>

  <script type="module">
    import { renderShell } from "/assets/shell.js";
    import { getLang, t } from "/assets/app.js";
    import { openModal, confirmModal } from "/assets/modal.js";
    import { requireFrontAuth } from "/assets/app.js";
    
    if (!requireFrontAuth()) throw new Error("NO_AUTH");


    const API_BASE = "https://api.tech.gekto.uz";

    const ui = renderShell({ active: "filials", titleKey: "filials" });

    let allItems = [];

    function L(ru, uz, en) {
      const lg = getLang();
      return lg === "uz" ? uz : (lg === "en" ? en : ru);
    }

    function token() {
      return localStorage.getItem("tech_token") || "";
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function fmtTs(ts) {
      if (!ts) return "";
      const d = new Date(ts * 1000);
      return d.toLocaleString();
    }

    async function apiFetch(path, opts = {}) {
      const tkn = token();
      if (!tkn) throw new Error("NO_TOKEN");

      const headers = Object.assign({}, opts.headers || {}, {
        "Authorization": "Bearer " + tkn
      });

      const r = await fetch(API_BASE + path, Object.assign({}, opts, { headers }));
      const data = await r.json().catch(() => ({}));

      if (r.status === 401) {
        localStorage.removeItem("tech_token");
        throw new Error("UNAUTHORIZED");
      }
      if (!r.ok || !data.ok) throw new Error(data.error || ("ERR_" + r.status));
      return data;
    }

    function openFilialForm({ mode, item }) {
      // mode: "create" | "edit"
      const isEdit = mode === "edit";
      const x = item || {};

      const id = isEdit ? x.id : "";
      const v_name = x.name || "";
      const v_code = x.code || "";
      const v_phone = x.phone || "";
      const v_address = x.address || "";
      const v_comment = x.comment || "";
      const v_timezone = x.timezone || "Asia/Tashkent";
      const v_currency = x.currency || "UZS";
      const v_default = x.is_default ? 1 : 0;
      const v_active = (x.is_active === 0) ? 0 : 1;

      openModal({
        title: isEdit ? t("edit_filial") : t("create_filial"),
        sub: isEdit ? ("ID: " + id) : "",
        okText: t("save"),
        cancelText: t("cancel"),
        bodyHtml: `
          <div class="form-grid">
            <div class="field">
              <label>${t("field_name")}</label>
              <input id="f_name" class="inp" value="${escapeHtml(v_name)}" />
            </div>
            <div class="field">
              <label>${t("field_code")}</label>
              <input id="f_code" class="inp" value="${escapeHtml(v_code)}" placeholder="BR001" />
            </div>

            <div class="field">
              <label>${t("field_phone")}</label>
              <input id="f_phone" class="inp" value="${escapeHtml(v_phone)}" placeholder="+998..." />
            </div>
            <div class="field">
              <label>${t("field_currency")}</label>
              <input id="f_currency" class="inp" value="${escapeHtml(v_currency)}" placeholder="UZS" />
            </div>

            <div class="field" style="grid-column:1 / -1;">
              <label>${t("field_address")}</label>
              <input id="f_address" class="inp" value="${escapeHtml(v_address)}" />
            </div>

            <div class="field" style="grid-column:1 / -1;">
              <label>${t("field_comment")}</label>
              <textarea id="f_comment" class="inp">${escapeHtml(v_comment)}</textarea>
            </div>

            <div class="field" style="grid-column:1 / -1;">
              <label>${t("field_timezone")}</label>
              <input id="f_timezone" class="inp" value="${escapeHtml(v_timezone)}" placeholder="Asia/Tashkent" />
            </div>

            <div class="switch" style="grid-column:1 / -1;">
              <div class="label">${t("switch_default")}</div>
              <input id="f_default" type="checkbox" ${v_default ? "checked" : ""} />
            </div>

            <div class="switch" style="grid-column:1 / -1;">
              <div class="label">${t("switch_active")}</div>
              <input id="f_active" type="checkbox" ${v_active ? "checked" : ""} />
            </div>
          </div>
        `,
        onOk: async () => {
          const payload = {
            name: (document.getElementById("f_name").value || "").trim(),
            code: (document.getElementById("f_code").value || "").trim() || null,
            phone: (document.getElementById("f_phone").value || "").trim() || null,
            address: (document.getElementById("f_address").value || "").trim() || null,
            comment: (document.getElementById("f_comment").value || "").trim() || null,
            timezone: (document.getElementById("f_timezone").value || "").trim() || "Asia/Tashkent",
            currency: (document.getElementById("f_currency").value || "").trim() || "UZS",
            is_default: document.getElementById("f_default").checked ? 1 : 0,
            is_active: document.getElementById("f_active").checked ? 1 : 0
          };

          if (!payload.name) throw new Error("name required");

          if (isEdit) {
            await apiFetch("/filials/" + id, {
              method: "PATCH",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
          } else {
            await apiFetch("/filials", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
          }

          await load();
        }
      });
    }


    async function loadWho() {
      try {
        const data = await apiFetch("/me");
        ui.setWho(getLang() === "uz"
          ? `Siz: ${data.user.full_name} (${data.user.role})`
          : `Ты: ${data.user.full_name} (${data.user.role})`
        );
      } catch {
        ui.setWho("");
      }
    }

    function renderTable() {
      const yes = t("yes");
      const no  = t("no");

      const q = (document.getElementById("q")?.value || "").trim().toLowerCase();
      const items = q ? allItems.filter(x => {
        const s = (x.name||"") + " " + (x.code||"") + " " + (x.phone||"");
        return s.toLowerCase().includes(q);
      }) : allItems;

      ui.setSub(items.length ? `(${items.length})` : "");

      if (!items.length) {
        ui.bodyEl.innerHTML = `
          <div class="tablewrap">
            <table>
              <tbody><tr><td style="padding:12px;">—</td></tr></tbody>
            </table>
          </div>`;
        return;
      }

      ui.bodyEl.innerHTML = `
        <div class="tablewrap">
          <table>
            <thead>
              <tr>
                <th style="width:80px;">ID</th>
                <th>${t("name")}</th>
                <th style="width:120px;">${t("code")}</th>
                <th style="width:150px;">${t("phone")}</th>
                <th style="width:110px;">${t("default")}</th>
                <th style="width:110px;">${t("active")}</th>
                <th style="width:220px;">${t("actions")}</th>
              </tr>
            </thead>
            <tbody id="rows">
              ${items.map(x => `
                <tr style="opacity:${x.is_active ? "1" : "0.55"}">
                  <td>${x.id}</td>
                  <td>${escapeHtml(x.name)}</td>
                  <td>${escapeHtml(x.code || "")}</td>
                  <td>${escapeHtml(x.phone || "")}</td>
                  <td>${x.is_default ? yes : no}</td>
                  <td>${x.is_active ? yes : no}</td>
                  <td style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn icon" data-act="edit" data-id="${x.id}" title="${L("Редактировать","Tahrirlash","Edit")}" aria-label="${L("Редактировать","Tahrirlash","Edit")}">
                          <!-- pencil -->
                          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                            <path d="M12 20h9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L8 18l-4 1 1-4 11.5-11.5Z"
                              stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                          </svg>
                        </button>

                        <button class="btn icon" data-act="toggle" data-id="${x.id}" data-next="${x.is_active ? 0 : 1}"
                                title="${x.is_active ? L("Деактивировать","O‘chirish","Disable") : L("Активировать","Yoqish","Enable")}"
                                aria-label="${x.is_active ? L("Деактивировать","O‘chirish","Disable") : L("Активировать","Yoqish","Enable")}">
                          ${x.is_active
                            ? `
                              <!-- trash -->
                              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                <path d="M3 6h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M8 6V4h8v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M7 6l1 14h8l1-14" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                                <path d="M10 11v6M14 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                              </svg>
                            `
                            : `
                              <!-- restore / undo -->
                              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                <path d="M9 14l-4-4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M5 10h9a5 5 0 1 1 0 10h-2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                              </svg>
                            `}
                        </button>
                    
                  </td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>`;
    }


    function mountActions() {
      ui.actionsEl.innerHTML = `
          <input id="q" class="inp" placeholder="${t("search")}" style="width:220px;" />
          <button id="refresh" class="btn">${t("refresh")}</button>
          <button id="add" class="btn primary">${t("add")}</button>
      `;

      document.getElementById("q").addEventListener("input", () => renderTable());
      document.getElementById("refresh").addEventListener("click", () => load());
      document.getElementById("add").addEventListener("click", async () => {openFilialForm({ mode: "create" });});
    }


    async function load() {
      const lg = getLang();
      try {
        ui.setMsg(lg === "uz" ? "Yuklanmoqda..." : "Загружаю...", true);
        const data = await apiFetch("/filials");
        allItems = data.items || [];
        ui.setMsg("", true);
        mountActions();
        renderTable();
      } catch (e) {
        const m = String(e.message || e);
        if (m === "NO_TOKEN" || m === "UNAUTHORIZED") {
          ui.setMsg(lg === "uz" ? "Iltimos, avval kiring (/auth/login.html)" : "Сначала войди (/auth/login.html)", false);
        } else {
          ui.setMsg("Ошибка: " + m, false);
        }
      }
    }

    // table buttons (rename/toggle)
    ui.bodyEl.addEventListener("click", async (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;

      const act = btn.getAttribute("data-act");
      const id = btn.getAttribute("data-id");
      if (!act || !id) return;

      const cur = allItems.find(x => String(x.id) === String(id));
      if (!cur) return;

      const lg = getLang();

      if (act === "edit") {
        openFilialForm({ mode: "edit", item: cur });
        return;
      }


      if (act === "toggle") {
        const nextActive = Number(btn.getAttribute("data-next"));

        const title = (lg === "en")
          ? `${nextActive === 1 ? "Enable" : "Disable"} branch "${cur.name}"?`
          : (lg === "uz")
            ? `"${cur.name}" filialini ${nextActive === 1 ? "yoqish" : "o‘chirish"}?`
            : `Точно ${nextActive === 1 ? "включить" : "выключить"} филиал "${cur.name}"?`;

        const ok = await confirmModal({
          title,
          bodyHtml: `<div class="muted" style="margin-top:6px;">${
            (lg === "en")
              ? "This will change branch status."
              : (lg === "uz")
                ? "Bu filial holatini o‘zgartiradi."
                : "Это изменит статус филиала."
          }</div>`,
          okText: (lg === "en")
            ? (nextActive === 1 ? "Enable" : "Disable")
            : (lg === "uz")
              ? (nextActive === 1 ? "Yoqish" : "O‘chirish")
              : (nextActive === 1 ? "Включить" : "Отключить"),
          cancelText: t("cancel"),
          danger: nextActive === 0
        });

        if (!ok) return;

        await apiFetch("/filials/" + id, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ is_active: nextActive })
        });
        await load();
      }
    });



    await loadWho();
    mountActions();
    await load();

    window.addEventListener("tech:lang", () => {
        mountActions();
        renderTable();
        loadWho();
    });
    
  </script>
</body>
</html>
