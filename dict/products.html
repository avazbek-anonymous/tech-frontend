<!doctype html>
<html lang="ru" data-theme="light" data-sidebar="open" data-lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tech — Products</title>
  <link rel="stylesheet" href="/assets/app.css" />
</head>

<body>
  <div id="app"></div>

  <script type="module">
    import { renderShell } from "/assets/shell.js";
    import { getLang, t, requireFrontAuth } from "/assets/app.js";
    import { openModal } from "/assets/modal.js";
    import { enhanceSelect } from "/assets/select.js";

    if (!requireFrontAuth()) throw new Error("NO_AUTH");

    const API_BASE = "https://api.tech.gekto.uz";
    const ui = renderShell({ active: "products", titleKey: "products" });

    let items = [];
    let categories = [];
    let units = [];
    let isSuperAdmin = false;
    let businessFilter = "";
    let businesses = [];

    function L(ru, uz, en) {
      const lg = getLang();
      return lg === "uz" ? uz : (lg === "en" ? en : ru);
    }

    function token() {
      return localStorage.getItem("tech_token") || "";
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    async function apiFetch(path, opts = {}) {
      const tkn = token();
      if (!tkn) throw new Error("NO_TOKEN");

      const headers = Object.assign({}, opts.headers || {}, {
        "Authorization": "Bearer " + tkn
      });

      const r = await fetch(API_BASE + path, Object.assign({}, opts, { headers }));
      const data = await r.json().catch(() => ({}));

      if (r.status === 401) {
        localStorage.removeItem("tech_token");
        throw new Error("UNAUTHORIZED");
      }
      if (!r.ok || !data.ok) throw new Error(data.error || ("ERR_" + r.status));
      return data;
    }

    async function loadWho() {
      try {
        const data = await apiFetch("/me");
        isSuperAdmin = (data?.user?.role === "super_admin");
        ui.setWho(getLang() === "uz"
          ? `Siz: ${data.user.full_name} (${data.user.role})`
          : (getLang()==="en"
            ? `You: ${data.user.full_name} (${data.user.role})`
            : `Ты: ${data.user.full_name} (${data.user.role})`
          )
        );
      } catch { ui.setWho(""); }
    }

    async function loadBusinesses() {
      if (!isSuperAdmin) return;
      const data = await apiFetch("/businesses");
      businesses = data.items || [];
    }

    async function loadRefs() {
      const q = businessFilter ? `?business_id=${encodeURIComponent(businessFilter)}` : "";
      const [catRes, unitRes] = await Promise.all([
        apiFetch("/product_categories" + q),
        apiFetch("/units" + q)
      ]);
      categories = catRes.items || [];
      units = unitRes.items || [];
    }

    function openProductForm({ mode, item }) {
      const isEdit = mode === "edit";
      const x = item || {};

      openModal({
        title: isEdit ? L("Редактировать товар", "Mahsulotni tahrirlash", "Edit product")
                      : L("Создать товар", "Mahsulot yaratish", "Create product"),
        okText: t("save"),
        cancelText: t("cancel"),
        bodyHtml: `
          <div class="form-grid">
            ${isSuperAdmin && !isEdit ? `
              <div class="field" style="grid-column:1 / -1;">
                <label>${L("Бизнес","Biznes","Business")}</label>
                <select id="p_business" class="inp">
                  ${businesses.map(b => `<option value="${b.id}">${escapeHtml(b.name)}</option>`).join("")}
                </select>
              </div>
            ` : ""}

            <div class="field" style="grid-column:1 / -1;">
              <label>${L("Категория","Kategoriya","Category")}</label>
              <select id="p_category" class="inp">
                <option value="">—</option>
                ${categories.map(c => `<option value="${c.id}" ${String(c.id)===String(x.category_id||"") ? "selected" : ""}>${escapeHtml(c.name)}</option>`).join("")}
              </select>
            </div>

            <div class="field" style="grid-column:1 / -1;">
              <label>${L("Единица","Birlik","Unit")}</label>
              <select id="p_unit" class="inp">
                <option value="">—</option>
                ${units.map(u => `<option value="${u.id}" ${String(u.id)===String(x.unit_id||"") ? "selected" : ""}>${escapeHtml(u.name)}</option>`).join("")}
              </select>
            </div>

            <div class="field">
              <label>${t("name")}</label>
              <input id="p_name" class="inp" value="${escapeHtml(x.name || "")}" />
            </div>
            <div class="field">
              <label>SKU</label>
              <input id="p_sku" class="inp" value="${escapeHtml(x.sku || "")}" />
            </div>
            <div class="field">
              <label>Barcode</label>
              <input id="p_barcode" class="inp" value="${escapeHtml(x.barcode || "")}" />
            </div>

            <div class="field">
              <label>VAT %</label>
              <input id="p_vat" class="inp" type="number" step="0.01" value="${escapeHtml(String(x.vat_rate ?? 0))}" />
            </div>
            <div class="field">
              <label>${L("Розничная цена","Chakana narx","Retail price")}</label>
              <input id="p_retail" class="inp" type="number" step="0.01" value="${escapeHtml(String(x.price_retail ?? 0))}" />
            </div>
            <div class="field">
              <label>${L("Оптовая цена","Ulgurji narx","Wholesale price")}</label>
              <input id="p_wholesale" class="inp" type="number" step="0.01" value="${escapeHtml(String(x.price_wholesale ?? 0))}" />
            </div>

            <div class="switch" style="grid-column:1 / -1;">
              <div class="label">${L("Серийные номера","Seriya raqami","Track serial")}</div>
              <input id="p_serial" type="checkbox" ${x.track_serial ? "checked" : ""} />
            </div>
            <div class="switch" style="grid-column:1 / -1;">
              <div class="label">IMEI</div>
              <input id="p_imei" type="checkbox" ${x.track_imei ? "checked" : ""} />
            </div>

            <div class="switch" style="grid-column:1 / -1;">
              <div class="label">${t("switch_active")}</div>
              <input id="p_active" type="checkbox" ${((x.is_active === 0) ? "" : "checked")} />
            </div>
          </div>
        `,
        onOk: async () => {
          const payload = {
            category_id: document.getElementById("p_category").value ? Number(document.getElementById("p_category").value) : null,
            unit_id: document.getElementById("p_unit").value ? Number(document.getElementById("p_unit").value) : null,
            name: (document.getElementById("p_name").value || "").trim(),
            sku: (document.getElementById("p_sku").value || "").trim() || null,
            barcode: (document.getElementById("p_barcode").value || "").trim() || null,
            vat_rate: Number(document.getElementById("p_vat").value || 0),
            price_retail: Number(document.getElementById("p_retail").value || 0),
            price_wholesale: Number(document.getElementById("p_wholesale").value || 0),
            track_serial: document.getElementById("p_serial").checked ? 1 : 0,
            track_imei: document.getElementById("p_imei").checked ? 1 : 0,
            is_active: document.getElementById("p_active").checked ? 1 : 0
          };
          if (!payload.name) throw new Error("name required");
          if (isSuperAdmin && !isEdit) {
            payload.business_id = Number(document.getElementById("p_business").value);
          }

          if (isEdit) {
            await apiFetch("/products/" + x.id, {
              method: "PATCH",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
          } else {
            await apiFetch("/products", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
          }

          await load();
        }
      });
      setTimeout(() => {
        const sel1 = document.getElementById("p_business");
        if (sel1) enhanceSelect(sel1);
        const sel2 = document.getElementById("p_category");
        if (sel2) enhanceSelect(sel2);
        const sel3 = document.getElementById("p_unit");
        if (sel3) enhanceSelect(sel3);
      }, 0);
    }

    function mountActions() {
      ui.actionsEl.innerHTML = `
        ${isSuperAdmin ? `
          <select id="biz" class="inp" style="width:220px;">
            <option value="">${L("Все бизнесы","Barcha bizneslar","All businesses")}</option>
            ${businesses.map(b => `<option value="${b.id}" ${String(b.id)===String(businessFilter) ? "selected" : ""}>${escapeHtml(b.name)}</option>`).join("")}
          </select>
        ` : ""}
        <input id="q" class="inp" placeholder="${t("search")}" style="width:220px;" />
        <button id="refresh" class="btn">${t("refresh")}</button>
        <button id="add" class="btn primary">${t("add")}</button>
      `;

      if (isSuperAdmin) {
        document.getElementById("biz").addEventListener("change", (e) => {
          businessFilter = (e.target.value || "").trim();
          load();
        });
        enhanceSelect(document.getElementById("biz"));
      }

      document.getElementById("q").addEventListener("input", () => renderTable());
      document.getElementById("refresh").addEventListener("click", () => load());
      document.getElementById("add").addEventListener("click", () => openProductForm({ mode: "create" }));
    }

    function renderTable() {
      const yes = t("yes");
      const no  = t("no");

      const q = (document.getElementById("q")?.value || "").trim().toLowerCase();
      const filtered = q ? items.filter(x => {
        const s = (x.name||"") + " " + (x.sku||"") + " " + (x.barcode||"");
        return s.toLowerCase().includes(q);
      }) : items;

      ui.setSub(filtered.length ? `(${filtered.length})` : "");

      if (!filtered.length) {
        ui.bodyEl.innerHTML = `
          <div class="tablewrap"><table><tbody><tr><td style="padding:12px;">—</td></tr></tbody></table></div>
        `;
        return;
      }

      ui.bodyEl.innerHTML = `
        <div class="tablewrap">
          <table>
            <thead>
              <tr>
                <th style="width:80px;">ID</th>
                ${isSuperAdmin ? `<th style="width:200px;">${L("Бизнес","Biznes","Business")}</th>` : ""}
                <th>${t("name")}</th>
                <th style="width:140px;">SKU</th>
                <th style="width:160px;">Barcode</th>
                <th style="width:180px;">${L("Категория","Kategoriya","Category")}</th>
                <th style="width:120px;">${L("Ед.","Birlik","Unit")}</th>
                <th style="width:140px;">${L("Розница","Chakana","Retail")}</th>
                <th style="width:140px;">${L("Опт","Ulgurji","Wholesale")}</th>
                <th style="width:120px;">${t("active")}</th>
                <th style="width:220px;">${t("actions")}</th>
              </tr>
            </thead>
            <tbody id="rows">
              ${filtered.map(x => `
                <tr style="opacity:${x.is_active ? "1" : "0.55"}">
                  <td>${x.id}</td>
                  ${isSuperAdmin ? `<td>${escapeHtml(businesses.find(b => String(b.id)===String(x.business_id))?.name || ("#" + (x.business_id ?? "")))}</td>` : ""}
                  <td>${escapeHtml(x.name)}</td>
                  <td>${escapeHtml(x.sku || "")}</td>
                  <td>${escapeHtml(x.barcode || "")}</td>
                  <td>${escapeHtml(x.category_name || "—")}</td>
                  <td>${escapeHtml(x.unit_name || "—")}</td>
                  <td>${escapeHtml(String(x.price_retail ?? 0))}</td>
                  <td>${escapeHtml(String(x.price_wholesale ?? 0))}</td>
                  <td>${x.is_active ? yes : no}</td>
                  <td style="display:flex; gap:8px; flex-wrap:wrap;">
                    <button class="btn icon" data-act="edit" data-id="${x.id}" title="${L("Редактировать","Tahrirlash","Edit")}" aria-label="${L("Редактировать","Tahrirlash","Edit")}">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M12 20h9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L8 18l-4 1 1-4 11.5-11.5Z"
                          stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                      </svg>
                    </button>
                    <button class="btn icon" data-act="toggle" data-id="${x.id}" data-next="${x.is_active ? 0 : 1}"
                            title="${x.is_active ? L("Отключить","O‘chirish","Disable") : L("Включить","Yoqish","Enable")}"
                            aria-label="${x.is_active ? L("Отключить","O‘chirish","Disable") : L("Включить","Yoqish","Enable")}">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M12 3v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <path d="M7.05 7.05a7 7 0 1 0 9.9 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                      </svg>
                    </button>
                  </td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>
      `;

      document.querySelectorAll("[data-act='edit']").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = Number(btn.getAttribute("data-id"));
          const item = items.find(x => Number(x.id) === id);
          if (item) openProductForm({ mode: "edit", item });
        });
      });
      document.querySelectorAll("[data-act='toggle']").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = Number(btn.getAttribute("data-id"));
          const next = Number(btn.getAttribute("data-next"));
          await apiFetch("/products/" + id, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ is_active: next })
          });
          await load();
        });
      });
    }

    async function load() {
      ui.setMsg(t("loading") || "Loading...");
      const q = businessFilter ? `?business_id=${encodeURIComponent(businessFilter)}` : "";
      await loadRefs();
      const data = await apiFetch("/products" + q);
      items = data.items || [];
      ui.setMsg("");
      renderTable();
    }

    async function init() {
      await loadWho();
      await loadBusinesses();
      mountActions();
      await load();
    }

    init().catch(e => ui.setMsg(String(e.message || e)));
  </script>
</body>
</html>
