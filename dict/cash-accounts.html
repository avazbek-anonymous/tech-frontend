<!doctype html>
<html lang="ru" data-theme="light" data-sidebar="open" data-lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tech — Cash Accounts</title>
  <link rel="stylesheet" href="/assets/app.css" />
</head>

<body>
  <div id="app"></div>

  <script type="module">
    import { renderShell } from "/assets/shell.js";
    import { getLang, t } from "/assets/app.js";
    import { openModal, confirmModal } from "/assets/modal.js";
    import { enhanceSelect } from "/assets/select.js";
    import { requireFrontAuth } from "/assets/app.js";
    
    if (!requireFrontAuth()) throw new Error("NO_AUTH");


    const API_BASE = "https://api.tech.gekto.uz";
    const ui = renderShell({ active: "cash_accounts", titleKey: "cash_accounts" });

    let filials = [];
    let items = [];

    let filialFilter = "";
    let kindFilter = "";
    let isSuperAdmin = false;
    let businessFilter = "";

    function L(ru, uz, en) {
      const lg = getLang();
      return lg === "uz" ? uz : (lg === "en" ? en : ru);
    }

    function token() {
      return localStorage.getItem("tech_token") || "";
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    async function apiFetch(path, opts = {}) {
      const tkn = token();
      if (!tkn) throw new Error("NO_TOKEN");

      const headers = Object.assign({}, opts.headers || {}, {
        "Authorization": "Bearer " + tkn
      });

      const r = await fetch(API_BASE + path, Object.assign({}, opts, { headers }));
      const data = await r.json().catch(() => ({}));

      if (r.status === 401) {
        localStorage.removeItem("tech_token");
        throw new Error("UNAUTHORIZED");
      }
      if (!r.ok || !data.ok) throw new Error(data.error || ("ERR_" + r.status));
      return data;
    }

    async function loadWho() {
      try {
        const data = await apiFetch("/me");
        isSuperAdmin = (data?.user?.role === "super_admin");
        ui.setWho(getLang() === "uz"
          ? `Siz: ${data.user.full_name} (${data.user.role})`
          : (getLang()==="en"
            ? `You: ${data.user.full_name} (${data.user.role})`
            : `Ты: ${data.user.full_name} (${data.user.role})`
          )
        );
      } catch { ui.setWho(""); }
    }

    function kindLabel(k) {
      if (k === "cash") return L("Наличные", "Naqd", "Cash");
      if (k === "card") return L("Терминал/карта", "Karta/terminal", "Card");
      if (k === "bank") return L("Банк/счёт", "Bank hisob", "Bank");
      return k || "";
    }

    function openForm({ mode, item }) {
      const isEdit = mode === "edit";
      const x = item || {};

      openModal({
        title: isEdit ? L("Редактировать кассу/счёт", "Kassa/hisobni tahrirlash", "Edit cash account")
                     : L("Создать кассу/счёт", "Kassa/hisob yaratish", "Create cash account"),
        okText: t("save"),
        cancelText: t("cancel"),
        bodyHtml: `
          <div class="form-grid">
            <div class="field" style="grid-column:1 / -1;">
              <label>${L("Филиал","Filial","Branch")}</label>
              <select id="c_filial" class="inp">
                ${filials.map(f => `<option value="${f.id}" ${String(f.id)===String(x.filial_id||filialFilter) ? "selected" : ""}>${escapeHtml(f.name)}</option>`).join("")}
              </select>
            </div>

            <div class="field">
              <label>${L("Название","Nomi","Name")}</label>
              <input id="c_name" class="inp" value="${escapeHtml(x.name || "")}" />
            </div>

            <div class="field">
              <label>${L("Тип","Turi","Kind")}</label>
              <select id="c_kind" class="inp">
                <option value="cash" ${String(x.kind||"cash")==="cash"?"selected":""}>${kindLabel("cash")}</option>
                <option value="card" ${String(x.kind||"")==="card"?"selected":""}>${kindLabel("card")}</option>
                <option value="bank" ${String(x.kind||"")==="bank"?"selected":""}>${kindLabel("bank")}</option>
              </select>
            </div>

            <div class="field">
              <label>${L("Валюта","Valyuta","Currency")}</label>
              <input id="c_currency" class="inp" value="${escapeHtml(x.currency || "UZS")}" placeholder="UZS" />
            </div>

            <div class="field">
              <label>${L("Код","Kod","Code")}</label>
              <input id="c_code" class="inp" value="${escapeHtml(x.code || "")}" placeholder="CASH01" />
            </div>

            <div class="field" style="grid-column:1 / -1;">
              <label>${L("Комментарий","Izoh","Comment")}</label>
              <textarea id="c_comment" class="inp">${escapeHtml(x.comment || "")}</textarea>
            </div>

            <div class="switch" style="grid-column:1 / -1;">
              <div class="label">${L("По умолчанию (на филиал/тип)","Standart (filial/tur)","Default (per branch/kind)")}</div>
              <input id="c_default" type="checkbox" ${(x.is_default ? "checked" : "")} />
            </div>

            <div class="switch" style="grid-column:1 / -1;">
              <div class="label">${t("switch_active")}</div>
              <input id="c_active" type="checkbox" ${((x.is_active === 0) ? "" : "checked")} />
            </div>
          </div>
        `,
        onOk: async () => {
          const payload = {
            filial_id: Number(document.getElementById("c_filial").value),
            name: (document.getElementById("c_name").value || "").trim(),
            kind: (document.getElementById("c_kind").value || "").trim(),
            currency: (document.getElementById("c_currency").value || "").trim() || "UZS",
            code: (document.getElementById("c_code").value || "").trim() || null,
            comment: (document.getElementById("c_comment").value || "").trim() || null,
            is_default: document.getElementById("c_default").checked ? 1 : 0,
            is_active: document.getElementById("c_active").checked ? 1 : 0
          };

          if (!payload.name) throw new Error("name required");

          if (isEdit) {
            await apiFetch("/cash-accounts/" + x.id, {
              method: "PATCH",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
          } else {
            await apiFetch("/cash-accounts", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
          }

          await load();
        }
      });

      setTimeout(() => {
        const s1 = document.getElementById("c_filial");
        const s2 = document.getElementById("c_kind");
        if (s1) enhanceSelect(s1);
        if (s2) enhanceSelect(s2);
      }, 0);
    }

    function mountActions() {
      ui.actionsEl.innerHTML = `
        ${isSuperAdmin ? `<input id="biz" class="inp" placeholder="business_id" style="width:140px;" value="${businessFilter}" />` : ""}
        <select id="filialSel" class="inp" style="width:220px;">
          <option value="">${L("Все филиалы","Barcha filiallar","All branches")}</option>
          ${filials.map(f => `<option value="${f.id}" ${String(f.id)===String(filialFilter) ? "selected" : ""}>${escapeHtml(f.name)}</option>`).join("")}
        </select>

        <select id="kindSel" class="inp" style="width:220px;">
          <option value="">${L("Все типы","Barcha turlar","All kinds")}</option>
          <option value="cash" ${kindFilter==="cash"?"selected":""}>${kindLabel("cash")}</option>
          <option value="card" ${kindFilter==="card"?"selected":""}>${kindLabel("card")}</option>
          <option value="bank" ${kindFilter==="bank"?"selected":""}>${kindLabel("bank")}</option>
        </select>

        <input id="q" class="inp" placeholder="${t("search")}" style="width:220px;" />
        <button id="refresh" class="btn">${t("refresh")}</button>
        <button id="add" class="btn primary">${t("add")}</button>
      `;

      enhanceSelect(document.getElementById("filialSel"));
      enhanceSelect(document.getElementById("kindSel"));

      if (isSuperAdmin) {
        document.getElementById("biz").addEventListener("change", (e) => {
          businessFilter = (e.target.value || "").trim();
          load();
        });
      }

      document.getElementById("filialSel").addEventListener("change", (e) => {
        filialFilter = e.target.value || "";
        renderTable();
      });

      document.getElementById("kindSel").addEventListener("change", (e) => {
        kindFilter = e.target.value || "";
        renderTable();
      });

      document.getElementById("q").addEventListener("input", () => renderTable());
      document.getElementById("refresh").addEventListener("click", () => load());
      document.getElementById("add").addEventListener("click", () => openForm({ mode: "create", item: { filial_id: filialFilter ? Number(filialFilter) : (filials[0]?.id || null), kind: kindFilter || "cash" } }));
    }

    function renderTable() {
      const yes = t("yes");
      const no  = t("no");
      const q = (document.getElementById("q")?.value || "").trim().toLowerCase();

      let view = items;
      if (filialFilter) view = view.filter(x => String(x.filial_id) === String(filialFilter));
      if (kindFilter) view = view.filter(x => String(x.kind) === String(kindFilter));
      if (q) {
        view = view.filter(x => {
          const s = (x.name||"") + " " + (x.kind||"") + " " + (x.currency||"") + " " + (x.code||"");
          return s.toLowerCase().includes(q);
        });
      }

      ui.setSub(view.length ? `(${view.length})` : "");

      if (!view.length) {
        ui.bodyEl.innerHTML = `
          <div class="tablewrap">
            <table><tbody><tr><td style="padding:12px;">—</td></tr></tbody></table>
          </div>`;
        return;
      }

      const filialNameById = new Map(filials.map(f => [String(f.id), f.name]));

      const editTitle = L("Редактировать", "Tahrirlash", "Edit");
      const disableTitle = L("Деактивировать", "O‘chirish", "Disable");
      const enableTitle  = L("Активировать", "Yoqish", "Enable");

      ui.bodyEl.innerHTML = `
        <div class="tablewrap">
          <table>
            <thead>
              <tr>
                <th style="width:80px;">ID</th>
                ${isSuperAdmin ? `<th style="width:120px;">business_id</th>` : ""}
                <th style="width:180px;">${L("Филиал","Filial","Branch")}</th>
                <th>${L("Название","Nomi","Name")}</th>
                <th style="width:140px;">${L("Тип","Turi","Kind")}</th>
                <th style="width:90px;">${L("Валюта","Valyuta","Currency")}</th>
                <th style="width:120px;">${L("Код","Kod","Code")}</th>
                <th style="width:120px;">${t("default")}</th>
                <th style="width:110px;">${t("active")}</th>
                <th style="width:140px;">${t("actions")}</th>
              </tr>
            </thead>
            <tbody>
              ${view.map(x => {
                const isOn = x.is_active ? 1 : 0;
                return `
                  <tr style="opacity:${isOn ? "1" : "0.55"}">
                    <td>${x.id}</td>
                    ${isSuperAdmin ? `<td>${x.business_id ?? ""}</td>` : ""}
                    <td>${escapeHtml(filialNameById.get(String(x.filial_id)) || ("#" + x.filial_id))}</td>
                    <td>${escapeHtml(x.name)}</td>
                    <td>${escapeHtml(kindLabel(x.kind))}</td>
                    <td>${escapeHtml(x.currency || "UZS")}</td>
                    <td>${escapeHtml(x.code || "")}</td>
                    <td>${x.is_default ? yes : no}</td>
                    <td>${isOn ? yes : no}</td>
                    <td style="display:flex; gap:8px; flex-wrap:wrap;">
                      <button class="btn icon" data-act="edit" data-id="${x.id}" title="${editTitle}" aria-label="${editTitle}">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                          <path d="M12 20h9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                          <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L8 18l-4 1 1-4 11.5-11.5Z"
                            stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                        </svg>
                      </button>

                      <button class="btn icon" data-act="toggle" data-id="${x.id}" data-next="${isOn ? 0 : 1}"
                              title="${isOn ? disableTitle : enableTitle}"
                              aria-label="${isOn ? disableTitle : enableTitle}">
                        ${isOn
                          ? `
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                              <path d="M3 6h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                              <path d="M8 6V4h8v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                              <path d="M7 6l1 14h8l1-14" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                              <path d="M10 11v6M14 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                          `
                          : `
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                              <path d="M9 14l-4-4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                              <path d="M5 10h9a5 5 0 1 1 0 10h-2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                          `}
                      </button>
                    </td>
                  </tr>
                `;
              }).join("")}
            </tbody>
          </table>
        </div>`;
    }

    async function load() {
      try {
        ui.setMsg(L("Загружаю...","Yuklanmoqda...","Loading..."), true);

        const qs = (isSuperAdmin && businessFilter) ? ("?business_id=" + encodeURIComponent(businessFilter)) : "";
        const f = await apiFetch("/filials" + qs);
        filials = f.items || [];

        const c = await apiFetch("/cash-accounts" + qs);
        items = c.items || [];

        ui.setMsg("", true);
        mountActions();
        renderTable();
      } catch (e) {
        const m = String(e.message || e);
        if (m === "NO_TOKEN" || m === "UNAUTHORIZED") {
          ui.setMsg(L("Сначала войди (/auth/login.html)","Avval kiring (/auth/login.html)","Please login (/auth/login.html)"), false);
        } else {
          ui.setMsg("Error: " + m, false);
        }
      }
    }

    ui.bodyEl.addEventListener("click", async (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;

      const act = btn.getAttribute("data-act");
      const id = btn.getAttribute("data-id");
      if (!act || !id) return;

      const cur = items.find(x => String(x.id) === String(id));
      if (!cur) return;

      if (act === "edit") {
        openForm({ mode: "edit", item: cur });
        return;
      }

      if (act === "toggle") {
        const next = Number(btn.getAttribute("data-next"));
        const conf = next === 0
          ? L(`Отключить "${cur.name}"?`, `"${cur.name}" o‘chirilsinmi?`, `Disable "${cur.name}"?`)
          : L(`Включить "${cur.name}"?`, `"${cur.name}" yoqilsinmi?`, `Enable "${cur.name}"?`);

        const ok = await confirmModal({
            title: conf,
            bodyHtml: `<div class="muted" style="margin-top:6px;">${L("Это изменит статус кассы/счёта.", "Bu kassa/hisob holatini o‘zgartiradi.", "This will change cash account status.")}</div>`,
            okText: next === 0 ? L("Отключить", "O‘chirish", "Disable") : L("Включить", "Yoqish", "Enable"),
            cancelText: t("cancel"),
            danger: next === 0
        });
        if (!ok) return;


        apiFetch("/cash-accounts/" + id, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ is_active: next })
        }).then(load).catch(err => ui.setMsg("Error: " + (err?.message || err), false));
      }
    });

    window.addEventListener("tech:lang", () => {
      ui.applyI18n();
      mountActions();
      renderTable();
      loadWho();
    });

    await loadWho();
    await load();
  </script>
</body>
</html>
