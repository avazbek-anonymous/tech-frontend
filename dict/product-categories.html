<!doctype html>
<html lang="ru" data-theme="light" data-sidebar="open" data-lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tech — Product Categories</title>
  <link rel="stylesheet" href="/assets/app.css" />
</head>

<body>
  <div id="app"></div>

  <script type="module">
    import { renderShell } from "/assets/shell.js";
    import { getLang, t, requireFrontAuth } from "/assets/app.js";
    import { openModal } from "/assets/modal.js";
    import { enhanceSelect } from "/assets/select.js";

    if (!requireFrontAuth()) throw new Error("NO_AUTH");

    const API_BASE = "https://api.tech.gekto.uz";
    const ui = renderShell({ active: "product_categories", titleKey: "product_categories" });

    let items = [];
    let isSuperAdmin = false;
    let businessFilter = "";
    let businesses = [];

    function L(ru, uz, en) {
      const lg = getLang();
      return lg === "uz" ? uz : (lg === "en" ? en : ru);
    }

    function token() {
      return localStorage.getItem("tech_token") || "";
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    async function apiFetch(path, opts = {}) {
      const tkn = token();
      if (!tkn) throw new Error("NO_TOKEN");

      const headers = Object.assign({}, opts.headers || {}, {
        "Authorization": "Bearer " + tkn
      });

      const r = await fetch(API_BASE + path, Object.assign({}, opts, { headers }));
      const data = await r.json().catch(() => ({}));

      if (r.status === 401) {
        localStorage.removeItem("tech_token");
        throw new Error("UNAUTHORIZED");
      }
      if (!r.ok || !data.ok) throw new Error(data.error || ("ERR_" + r.status));
      return data;
    }

    async function loadWho() {
      try {
        const data = await apiFetch("/me");
        isSuperAdmin = (data?.user?.role === "super_admin");
        ui.setWho(getLang() === "uz"
          ? `Siz: ${data.user.full_name} (${data.user.role})`
          : (getLang()==="en"
            ? `You: ${data.user.full_name} (${data.user.role})`
            : `Ты: ${data.user.full_name} (${data.user.role})`
          )
        );
      } catch { ui.setWho(""); }
    }

    async function loadBusinesses() {
      if (!isSuperAdmin) return;
      const data = await apiFetch("/businesses");
      businesses = data.items || [];
    }

    function openCategoryForm({ mode, item }) {
      const isEdit = mode === "edit";
      const x = item || {};

      openModal({
        title: isEdit ? L("Редактировать категорию", "Kategoriyani tahrirlash", "Edit category")
                      : L("Создать категорию", "Kategoriya yaratish", "Create category"),
        okText: t("save"),
        cancelText: t("cancel"),
        bodyHtml: `
          <div class="form-grid">
            ${isSuperAdmin && !isEdit ? `
              <div class="field" style="grid-column:1 / -1;">
                <label>${L("Бизнес","Biznes","Business")}</label>
                <select id="c_business" class="inp">
                  ${businesses.map(b => `<option value="${b.id}">${escapeHtml(b.name)}</option>`).join("")}
                </select>
              </div>
            ` : ""}

            <div class="field" style="grid-column:1 / -1;">
              <label>${L("Родительская категория","Ota kategoriya","Parent category")}</label>
              <select id="c_parent" class="inp">
                <option value="">—</option>
                ${items
                  .filter(it => !isEdit || String(it.id) !== String(x.id))
                  .map(it => `<option value="${it.id}" ${String(it.id)===String(x.parent_id||"") ? "selected" : ""}>${escapeHtml(it.name)}</option>`)
                  .join("")}
              </select>
            </div>

            <div class="field">
              <label>${t("name")}</label>
              <input id="c_name" class="inp" value="${escapeHtml(x.name || "")}" />
            </div>
            <div class="field">
              <label>${t("code")}</label>
              <input id="c_code" class="inp" value="${escapeHtml(x.code || "")}" placeholder="CAT001" />
            </div>

            <div class="switch" style="grid-column:1 / -1;">
              <div class="label">${t("switch_active")}</div>
              <input id="c_active" type="checkbox" ${((x.is_active === 0) ? "" : "checked")} />
            </div>
          </div>
        `,
        onOk: async () => {
          const payload = {
            parent_id: document.getElementById("c_parent").value ? Number(document.getElementById("c_parent").value) : null,
            name: (document.getElementById("c_name").value || "").trim(),
            code: (document.getElementById("c_code").value || "").trim() || null,
            is_active: document.getElementById("c_active").checked ? 1 : 0
          };
          if (!payload.name) throw new Error("name required");
          if (isSuperAdmin && !isEdit) {
            payload.business_id = Number(document.getElementById("c_business").value);
          }

          if (isEdit) {
            await apiFetch("/product_categories/" + x.id, {
              method: "PATCH",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
          } else {
            await apiFetch("/product_categories", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
          }

          await load();
        }
      });
      setTimeout(() => {
        const sel1 = document.getElementById("c_business");
        if (sel1) enhanceSelect(sel1);
        const sel2 = document.getElementById("c_parent");
        if (sel2) enhanceSelect(sel2);
      }, 0);
    }

    function mountActions() {
      ui.actionsEl.innerHTML = `
        ${isSuperAdmin ? `
          <select id="biz" class="inp" style="width:220px;">
            <option value="">${L("Все бизнесы","Barcha bizneslar","All businesses")}</option>
            ${businesses.map(b => `<option value="${b.id}" ${String(b.id)===String(businessFilter) ? "selected" : ""}>${escapeHtml(b.name)}</option>`).join("")}
          </select>
        ` : ""}
        <input id="q" class="inp" placeholder="${t("search")}" style="width:220px;" />
        <button id="refresh" class="btn">${t("refresh")}</button>
        <button id="add" class="btn primary">${t("add")}</button>
      `;

      if (isSuperAdmin) {
        document.getElementById("biz").addEventListener("change", (e) => {
          businessFilter = (e.target.value || "").trim();
          load();
        });
        enhanceSelect(document.getElementById("biz"));
      }

      document.getElementById("q").addEventListener("input", () => renderTable());
      document.getElementById("refresh").addEventListener("click", () => load());
      document.getElementById("add").addEventListener("click", () => openCategoryForm({ mode: "create" }));
    }

    function renderTable() {
      const yes = t("yes");
      const no  = t("no");

      const q = (document.getElementById("q")?.value || "").trim().toLowerCase();
      const filtered = q ? items.filter(x => {
        const s = (x.name||"") + " " + (x.code||"");
        return s.toLowerCase().includes(q);
      }) : items;

      ui.setSub(filtered.length ? `(${filtered.length})` : "");

      if (!filtered.length) {
        ui.bodyEl.innerHTML = `
          <div class="tablewrap"><table><tbody><tr><td style="padding:12px;">—</td></tr></tbody></table></div>
        `;
        return;
      }

      const parentName = (id) => items.find(x => Number(x.id) === Number(id))?.name || "";

      ui.bodyEl.innerHTML = `
        <div class="tablewrap">
          <table>
            <thead>
              <tr>
                <th style="width:80px;">ID</th>
                ${isSuperAdmin ? `<th style="width:200px;">${L("Бизнес","Biznes","Business")}</th>` : ""}
                <th>${t("name")}</th>
                <th style="width:180px;">${L("Родитель","Ota","Parent")}</th>
                <th style="width:160px;">${t("code")}</th>
                <th style="width:120px;">${t("active")}</th>
                <th style="width:220px;">${t("actions")}</th>
              </tr>
            </thead>
            <tbody id="rows">
              ${filtered.map(x => `
                <tr style="opacity:${x.is_active ? "1" : "0.55"}">
                  <td>${x.id}</td>
                  ${isSuperAdmin ? `<td>${escapeHtml(businesses.find(b => String(b.id)===String(x.business_id))?.name || ("#" + (x.business_id ?? "")))}</td>` : ""}
                  <td>${escapeHtml(x.name)}</td>
                  <td>${escapeHtml(parentName(x.parent_id) || "—")}</td>
                  <td>${escapeHtml(x.code || "")}</td>
                  <td>${x.is_active ? yes : no}</td>
                  <td style="display:flex; gap:8px; flex-wrap:wrap;">
                    <button class="btn icon" data-act="edit" data-id="${x.id}" title="${L("Редактировать","Tahrirlash","Edit")}" aria-label="${L("Редактировать","Tahrirlash","Edit")}">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M12 20h9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L8 18l-4 1 1-4 11.5-11.5Z"
                          stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                      </svg>
                    </button>
                    <button class="btn icon" data-act="toggle" data-id="${x.id}" data-next="${x.is_active ? 0 : 1}"
                            title="${x.is_active ? L("Отключить","O‘chirish","Disable") : L("Включить","Yoqish","Enable")}"
                            aria-label="${x.is_active ? L("Отключить","O‘chirish","Disable") : L("Включить","Yoqish","Enable")}">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M12 3v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <path d="M7.05 7.05a7 7 0 1 0 9.9 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                      </svg>
                    </button>
                  </td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>
      `;

      document.querySelectorAll("[data-act='edit']").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = Number(btn.getAttribute("data-id"));
          const item = items.find(x => Number(x.id) === id);
          if (item) openCategoryForm({ mode: "edit", item });
        });
      });
      document.querySelectorAll("[data-act='toggle']").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = Number(btn.getAttribute("data-id"));
          const next = Number(btn.getAttribute("data-next"));
          await apiFetch("/product_categories/" + id, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ is_active: next })
          });
          await load();
        });
      });
    }

    async function load() {
      ui.setMsg(t("loading") || "Loading...");
      const q = businessFilter ? `?business_id=${encodeURIComponent(businessFilter)}` : "";
      const data = await apiFetch("/product_categories" + q);
      items = data.items || [];
      ui.setMsg("");
      renderTable();
    }

    async function init() {
      await loadWho();
      await loadBusinesses();
      mountActions();
      await load();
    }

    init().catch(e => ui.setMsg(String(e.message || e)));
  </script>
</body>
</html>
