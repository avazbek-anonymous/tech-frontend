<!doctype html>
<html lang="ru" data-theme="light" data-sidebar="open" data-lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tech — Бизнесы</title>
  <link rel="stylesheet" href="/assets/app.css" />
</head>

<body>
  <div id="app"></div>

  <script type="module">
    import { renderShell } from "/assets/shell.js";
    import { getLang, t, requireFrontAuth } from "/assets/app.js";
    import { openModal, confirmModal } from "/assets/modal.js";

    if (!requireFrontAuth()) throw new Error("NO_AUTH");

    const API_BASE = "https://api.tech.gekto.uz";
    const ui = renderShell({ active: "businesses", titleKey: "businesses" });

    let allItems = [];
    let isSuperAdmin = false;

    function L(ru, uz, en) {
      const lg = getLang();
      return lg === "uz" ? uz : (lg === "en" ? en : ru);
    }

    function token() {
      return localStorage.getItem("tech_token") || "";
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function fmtTs(ts) {
      if (!ts) return "";
      const d = new Date(ts * 1000);
      return d.toLocaleString();
    }

    async function apiFetch(path, opts = {}) {
      const tkn = token();
      if (!tkn) throw new Error("NO_TOKEN");

      const headers = Object.assign({}, opts.headers || {}, {
        "Authorization": "Bearer " + tkn
      });

      const r = await fetch(API_BASE + path, Object.assign({}, opts, { headers }));
      const data = await r.json().catch(() => ({}));

      if (r.status === 401) {
        localStorage.removeItem("tech_token");
        throw new Error("UNAUTHORIZED");
      }
      if (!r.ok || !data.ok) throw new Error(data.error || ("ERR_" + r.status));
      return data;
    }

    async function loadWho() {
      try {
        const data = await apiFetch("/me");
        const role = data?.user?.role || "";
        isSuperAdmin = role === "super_admin";

        if (!isSuperAdmin) {
          ui.actionsEl.innerHTML = "";
          ui.bodyEl.innerHTML = "";
          ui.setMsg(L(
            "Доступ только для super_admin",
            "Faqat super_admin uchun",
            "Access only for super_admin"
          ), false);
          return;
        }

        ui.setWho(getLang() === "uz"
          ? `Siz: ${data.user.full_name} (${data.user.role})`
          : `Ты: ${data.user.full_name} (${data.user.role})`
        );
      } catch {
        ui.setWho("");
      }
    }

    function openBusinessForm({ mode, item }) {
      const isEdit = mode === "edit";
      const x = item || {};

      const v_name = x.name || "";
      const v_tariff = x.tariff_plan || "";
      const v_verified = x.verified ? 1 : 0;
      const v_status = x.status || "active";

      openModal({
        title: isEdit ? t("edit_business") : t("create_business"),
        sub: isEdit ? ("ID: " + x.id) : "",
        okText: t("save"),
        cancelText: t("cancel"),
        bodyHtml: `
          <div class="form-grid">
            <div class="field" style="grid-column:1 / -1;">
              <label>${t("name")}</label>
              <input id="b_name" class="inp" value="${escapeHtml(v_name)}" />
            </div>

            ${isEdit ? "" : `
              <div class="field">
                <label>${t("owner_email")}</label>
                <input id="b_email" class="inp" placeholder="owner@company.com" />
              </div>
              <div class="field">
                <label>${t("owner_full_name")}</label>
                <input id="b_full" class="inp" placeholder="Owner Name" />
              </div>
              <div class="field" style="grid-column:1 / -1;">
                <label>${t("password")}</label>
                <input id="b_password" class="inp" type="password" placeholder="Min 8 chars" />
              </div>
            `}

            <div class="field">
              <label>${t("tariff_plan")}</label>
              <input id="b_tariff" class="inp" value="${escapeHtml(v_tariff)}" placeholder="trial/pro" />
            </div>
            <div class="field">
              <label>${t("status")}</label>
              <select id="b_status" class="inp">
                <option value="active" ${v_status === "active" ? "selected" : ""}>${t("active_status")}</option>
                <option value="blocked" ${v_status === "blocked" ? "selected" : ""}>${t("blocked_status")}</option>
              </select>
            </div>

            <div class="switch" style="grid-column:1 / -1;">
              <div class="label">${t("verified")}</div>
              <input id="b_verified" type="checkbox" ${v_verified ? "checked" : ""} />
            </div>
          </div>
        `,
        onOk: async () => {
          const payload = {
            name: (document.getElementById("b_name").value || "").trim(),
            tariff_plan: (document.getElementById("b_tariff").value || "").trim() || null,
            status: document.getElementById("b_status").value,
            verified: document.getElementById("b_verified").checked ? 1 : 0
          };

          if (!payload.name) throw new Error("name required");

          if (isEdit) {
            await apiFetch("/businesses/" + x.id, {
              method: "PATCH",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
          } else {
            payload.owner_email = (document.getElementById("b_email").value || "").trim();
            payload.owner_full_name = (document.getElementById("b_full").value || "").trim();
            payload.password = (document.getElementById("b_password").value || "");

            await apiFetch("/businesses", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
          }

          await load();
        }
      });
    }

    function renderTable() {
      const yes = t("yes");
      const no = t("no");

      const q = (document.getElementById("q")?.value || "").trim().toLowerCase();
      const items = q ? allItems.filter(x => {
        const s = (x.name || "") + " " + (x.tariff_plan || "") + " " + (x.status || "");
        return s.toLowerCase().includes(q);
      }) : allItems;

      ui.setSub(items.length ? `(${items.length})` : "");

      if (!items.length) {
        ui.bodyEl.innerHTML = `
          <div class="tablewrap">
            <table>
              <tbody><tr><td style="padding:12px;">—</td></tr></tbody>
            </table>
          </div>`;
        return;
      }

      ui.bodyEl.innerHTML = `
        <div class="tablewrap">
          <table>
            <thead>
              <tr>
                <th style="width:80px;">ID</th>
                <th>${t("name")}</th>
                <th style="width:120px;">${t("status")}</th>
                <th style="width:110px;">${t("verified")}</th>
                <th style="width:140px;">${t("tariff_plan")}</th>
                <th style="width:170px;">${t("created")}</th>
                <th style="width:220px;">${t("actions")}</th>
              </tr>
            </thead>
            <tbody id="rows">
              ${items.map(x => `
                <tr style="opacity:${x.status === "blocked" ? "0.6" : "1"}">
                  <td>${x.id}</td>
                  <td>${escapeHtml(x.name)}</td>
                  <td>${x.status === "blocked" ? t("blocked_status") : t("active_status")}</td>
                  <td>${x.verified ? yes : no}</td>
                  <td>${escapeHtml(x.tariff_plan || "")}</td>
                  <td>${fmtTs(x.created_at)}</td>
                  <td style="display:flex; gap:8px; flex-wrap:wrap;">
                    <button class="btn icon" data-act="edit" data-id="${x.id}" title="${L("Редактировать","Tahrirlash","Edit")}" aria-label="${L("Редактировать","Tahrirlash","Edit")}">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M12 20h9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L8 18l-4 1 1-4 11.5-11.5Z"
                          stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                      </svg>
                    </button>

                    <button class="btn icon" data-act="toggle" data-id="${x.id}" data-next="${x.status === "blocked" ? "active" : "blocked"}"
                            title="${x.status === "blocked" ? L("Разблокировать","Yoqish","Unblock") : L("Заблокировать","Bloklash","Block")}"
                            aria-label="${x.status === "blocked" ? L("Разблокировать","Yoqish","Unblock") : L("Заблокировать","Bloklash","Block")}">
                      ${x.status === "blocked"
                        ? `
                          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                            <path d="M9 14l-4-4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M5 10h9a5 5 0 1 1 0 10h-2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                          </svg>
                        `
                        : `
                          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                            <rect x="5" y="4" width="14" height="16" rx="2" stroke="currentColor" stroke-width="2"/>
                            <path d="M9 10h6M9 14h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                          </svg>
                        `}
                    </button>
                  </td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>`;
    }

    function mountActions() {
      ui.actionsEl.innerHTML = `
        <input id="q" class="inp" placeholder="${t("search")}" style="width:220px;" />
        <button id="refresh" class="btn">${t("refresh")}</button>
        <button id="add" class="btn primary">${t("add")}</button>
      `;

      document.getElementById("q").addEventListener("input", () => renderTable());
      document.getElementById("refresh").addEventListener("click", () => load());
      document.getElementById("add").addEventListener("click", () => openBusinessForm({ mode: "create" }));
    }

    async function load() {
      const lg = getLang();
      try {
        ui.setMsg(lg === "uz" ? "Yuklanmoqda..." : "Загружаю...", true);
        const data = await apiFetch("/businesses");
        allItems = data.items || [];
        ui.setMsg("", true);
        mountActions();
        renderTable();
      } catch (e) {
        const m = String(e.message || e);
        if (m === "NO_TOKEN" || m === "UNAUTHORIZED") {
          ui.setMsg(lg === "uz" ? "Iltimos, avval kiring (/auth/login.html)" : "Сначала войди (/auth/login.html)", false);
        } else {
          ui.setMsg("Ошибка: " + m, false);
        }
      }
    }

    ui.bodyEl.addEventListener("click", async (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;

      const act = btn.getAttribute("data-act");
      const id = btn.getAttribute("data-id");
      if (!act || !id) return;

      const cur = allItems.find(x => String(x.id) === String(id));
      if (!cur) return;

      if (act === "edit") {
        openBusinessForm({ mode: "edit", item: cur });
        return;
      }

      if (act === "toggle") {
        const nextStatus = btn.getAttribute("data-next");
        const title = (nextStatus === "blocked")
          ? L(`Заблокировать "${cur.name}"?`, `"${cur.name}" bloklansinmi?`, `Block "${cur.name}"?`)
          : L(`Разблокировать "${cur.name}"?`, `"${cur.name}" yoqilsinmi?`, `Unblock "${cur.name}"?`);

        const ok = await confirmModal({
          title,
          bodyHtml: `<div class="muted" style="margin-top:6px;">${
            (nextStatus === "blocked")
              ? L("Бизнес станет недоступен.", "Biznes bloklanadi.", "Business will be blocked.")
              : L("Бизнес снова станет активным.", "Biznes qayta faollashadi.", "Business will be active again.")
          }</div>`,
          okText: (nextStatus === "blocked")
            ? L("Заблокировать","Bloklash","Block")
            : L("Разблокировать","Yoqish","Unblock"),
          cancelText: t("cancel"),
          danger: nextStatus === "blocked"
        });

        if (!ok) return;

        await apiFetch("/businesses/" + id, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ status: nextStatus })
        });
        await load();
      }
    });

    await loadWho();
    if (isSuperAdmin) {
      mountActions();
      await load();
    }

    window.addEventListener("tech:lang", async () => {
      await loadWho();
      if (isSuperAdmin) {
        mountActions();
        renderTable();
      }
    });
  </script>
</body>
</html>
